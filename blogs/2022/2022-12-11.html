<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>μC/OSIII学习day10 | viys</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="favicon.png">
    <script>
          var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?b0aae218897fa9d8a9f76e9a77e0b3c6";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
          })();
        </script>
    <meta name="description" content="温柔才是宝藏，你也是">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="msvalidate.01" content="995BE321E828B6205FA316BCC0116630">
    
    <link rel="preload" href="/assets/css/0.styles.1d5d80ee.css" as="style"><link rel="preload" href="/assets/js/app.88e14013.js" as="script"><link rel="preload" href="/assets/js/3.a7922583.js" as="script"><link rel="preload" href="/assets/js/1.890579b8.js" as="script"><link rel="preload" href="/assets/js/16.671f3930.js" as="script"><link rel="prefetch" href="/assets/js/10.0c84f94a.js"><link rel="prefetch" href="/assets/js/11.8a8b6d41.js"><link rel="prefetch" href="/assets/js/12.00b30763.js"><link rel="prefetch" href="/assets/js/13.e38f5f8a.js"><link rel="prefetch" href="/assets/js/14.02144b91.js"><link rel="prefetch" href="/assets/js/15.67b3306f.js"><link rel="prefetch" href="/assets/js/17.09e62461.js"><link rel="prefetch" href="/assets/js/18.1843f437.js"><link rel="prefetch" href="/assets/js/19.86b824eb.js"><link rel="prefetch" href="/assets/js/20.7066bbd1.js"><link rel="prefetch" href="/assets/js/21.4d141867.js"><link rel="prefetch" href="/assets/js/22.df4be56b.js"><link rel="prefetch" href="/assets/js/23.5048a92e.js"><link rel="prefetch" href="/assets/js/24.7c4cca11.js"><link rel="prefetch" href="/assets/js/25.1c23ab8a.js"><link rel="prefetch" href="/assets/js/26.a4863835.js"><link rel="prefetch" href="/assets/js/27.53863764.js"><link rel="prefetch" href="/assets/js/28.6a163b38.js"><link rel="prefetch" href="/assets/js/29.f54ae3de.js"><link rel="prefetch" href="/assets/js/30.53e19ce6.js"><link rel="prefetch" href="/assets/js/31.9cb47c73.js"><link rel="prefetch" href="/assets/js/32.d0a996fc.js"><link rel="prefetch" href="/assets/js/33.4d4c3f90.js"><link rel="prefetch" href="/assets/js/34.9b00d023.js"><link rel="prefetch" href="/assets/js/35.4a3f555e.js"><link rel="prefetch" href="/assets/js/4.8a2b8ed1.js"><link rel="prefetch" href="/assets/js/5.fa3e6dfb.js"><link rel="prefetch" href="/assets/js/6.298b5948.js"><link rel="prefetch" href="/assets/js/7.47c95cae.js"><link rel="prefetch" href="/assets/js/8.f0271449.js"><link rel="prefetch" href="/assets/js/9.50e96886.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1d5d80ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1db74182><div data-v-1db74182><div id="loader-wrapper" class="loading-wrapper" data-v-57c58703 data-v-1db74182 data-v-1db74182><div class="loader-main" data-v-57c58703><div data-v-57c58703></div><div data-v-57c58703></div><div data-v-57c58703></div><div data-v-57c58703></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-5cb9a64e data-v-1db74182 data-v-1db74182><h3 class="title" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e>viys</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><input type="password" value="" data-v-5cb9a64e> <span data-v-5cb9a64e>Konck! Knock!</span> <button data-v-5cb9a64e>OK</button></label> <div class="footer" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><span data-v-5cb9a64e><i class="iconfont reco-theme" data-v-5cb9a64e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-5cb9a64e>vuePress-theme-reco</a></span> <span data-v-5cb9a64e><i class="iconfont reco-copyright" data-v-5cb9a64e></i> <a data-v-5cb9a64e><span data-v-5cb9a64e>viys</span>
            
          <span data-v-5cb9a64e>2022 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-1db74182><div data-v-1db74182><div id="smart" class="wrapper-page" style="background-image:url(/images/5.jpg);background-position-x:center;background-position-y:center;background-size:cover;background-repeat-x:no-repeat;background-repeat-y:no-repeat;" data-v-1db74182><header class="navbar" data-v-1db74182><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/mylogo.png" alt="viys" class="logo"> <span class="site-name">viys</span></a> <div class="links"><div id="dayNightSwitch" class="generalWrapper" data-v-32f44868><a class="click" data-v-32f44868><div class="onOff daySwitch" data-v-32f44868><div class="star star1" data-v-32f44868></div> <div class="star star2" data-v-32f44868></div> <div class="star star3" data-v-32f44868></div> <div class="star star4" data-v-32f44868></div> <div class="star star5" data-v-32f44868></div> <div class="star sky" data-v-32f44868></div> <div class="sunMoon" data-v-32f44868><div class="crater crater1" data-v-32f44868></div> <div class="crater crater2" data-v-32f44868></div> <div class="crater crater3" data-v-32f44868></div> <div class="cloud part1" data-v-32f44868></div> <div class="cloud part2" data-v-32f44868></div></div></div></a></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/项目日志/" class="nav-link"><i class="iconfont undefined"></i>
  项目日志
</a></li><li class="dropdown-item"><!----> <a href="/categories/学习笔记/" class="nav-link"><i class="iconfont undefined"></i>
  学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/进步计划/" class="nav-link"><i class="iconfont undefined"></i>
  进步计划
</a></li><li class="dropdown-item"><!----> <a href="/categories/700实例/" class="nav-link"><i class="iconfont undefined"></i>
  700实例
</a></li><li class="dropdown-item"><!----> <a href="/categories/Terminal/" class="nav-link"><i class="iconfont undefined"></i>
  Terminal
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1db74182></div> <aside class="sidebar" data-v-1db74182><div class="personal-info-wrapper" data-v-03833281 data-v-1db74182><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/avatar_top.png" alt="author-avatar" class="personal-img" data-v-03833281> <h3 class="name" data-v-03833281>
    viys
  </h3> <div class="num" data-v-03833281><div data-v-03833281><h3 data-v-03833281>22</h3> <h6 data-v-03833281>文章</h6></div> <div data-v-03833281><h3 data-v-03833281>21</h3> <h6 data-v-03833281>标签</h6></div></div> <hr data-v-03833281></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/项目日志/" class="nav-link"><i class="iconfont undefined"></i>
  项目日志
</a></li><li class="dropdown-item"><!----> <a href="/categories/学习笔记/" class="nav-link"><i class="iconfont undefined"></i>
  学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/进步计划/" class="nav-link"><i class="iconfont undefined"></i>
  进步计划
</a></li><li class="dropdown-item"><!----> <a href="/categories/700实例/" class="nav-link"><i class="iconfont undefined"></i>
  700实例
</a></li><li class="dropdown-item"><!----> <a href="/categories/Terminal/" class="nav-link"><i class="iconfont undefined"></i>
  Terminal
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-5cb9a64e data-v-1db74182><h3 class="title" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e>μC/OSIII学习day10</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><input type="password" value="" data-v-5cb9a64e> <span data-v-5cb9a64e>Konck! Knock!</span> <button data-v-5cb9a64e>OK</button></label> <div class="footer" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><span data-v-5cb9a64e><i class="iconfont reco-theme" data-v-5cb9a64e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-5cb9a64e>vuePress-theme-reco</a></span> <span data-v-5cb9a64e><i class="iconfont reco-copyright" data-v-5cb9a64e></i> <a data-v-5cb9a64e><span data-v-5cb9a64e>viys</span>
            
          <span data-v-5cb9a64e>2022 - </span>
          2023
        </a></span></div></div></div> <div data-v-1db74182><main class="page"><div class="page-title" style="display:none;"><h1 class="title">μC/OSIII学习day10</h1> <div class="page-info" data-v-0efa1f05><i class="iconfont reco-account" data-v-0efa1f05><span data-v-0efa1f05>viys</span></i> <i class="iconfont reco-date" data-v-0efa1f05><span data-v-0efa1f05>2022-12-11</span></i> <!----> <i class="iconfont reco-tag tags" data-v-0efa1f05><span class="tag-item" data-v-0efa1f05>μC/OS</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block tip"><p class="custom-block-title">介绍</p> <p>任务信号量,任务消息队列</p></div> <h1 id="任务信号量"><a href="#任务信号量" class="header-anchor">#</a> 任务信号量</h1> <h2 id="任务信号量的基本概念"><a href="#任务信号量的基本概念" class="header-anchor">#</a> 任务信号量的基本概念</h2> <ul><li>μC/OS提供任务信号量这个功能,每个任务都有一个32位(用户可以自定义位宽,我们使用32位的CPU,此处就是32位)的信号量值SemCtr,这个信号量值是在任务控制块中包含的,是任务独有的一个信号量通知值,在大多数情况下,任务信号量可以替代内核对象的二值信号量,计数信号量等(而非内核对象信号量,如非特别说明,本章中的信号量都指的是内核对象信号量.前面所讲的信号量是单独的内核对象,是独立于任务存在的;本章要讲述的任务信号量是任务特有的属性,紧紧依赖于一个特定任务).</li> <li>相对于前面使用μC/OS内核通信的资源,必须创建二进制信号量,计数信号量等情况,使用任务信号量显然更灵活.因为使用任务信号量比通过内核对象信号量通信方式解除阻塞的任务的速度要快,并且更加节省RAM内存空间,任务信号量的使用无需单独创建信号量.</li> <li>通过对任务信号量的合理使用,可以在一定场合下替代μC/OS的信号量,用户只需向任务内部的信号量发送一个信号而不用通过外部的信号量进行发送,这样子处理就会很方便并且更加高效,当然,凡事都有利弊,不然的话μC/OS还要内核的IPC通信机制干嘛,任务信号量虽然处理更快,RAM开销更小,但也有限制:只能有一个任务接收任务信号量,因为必须指定接收信号量的任务,才能正确发送信号量;而内核对象的信号量则没有这个限制,用户在释放信号量,可以采用广播的方式,让所有等待信号量的任务都获取到信号量.</li> <li>在实际任务间的通信中,一个或多个任务发送一个信号量给另一个任务是非常常见的,而一个任务给多个任务发送信号量的情况相对比较少.这种情况就很适合采用任务信号量进行传递信号,如果任务信号量可以满足设计需求,那么尽量不要使用普通信号量,这样子设计的系统会更加高效.</li> <li>任务信号量的运作机制与普通信号量一样,没什么差别.</li></ul> <h2 id="任务信号量的函数接口讲解"><a href="#任务信号量的函数接口讲解" class="header-anchor">#</a> 任务信号量的函数接口讲解</h2> <table><thead><tr><th>函数名称</th> <th>函数作用</th></tr></thead> <tbody><tr><td>OSTaskSemPost()</td> <td>释放任务信号量</td></tr> <tr><td>OSTaskSemPend()</td> <td>获取一个任务信号</td></tr></tbody></table> <ul><li><p>任务信号量释放函数OSTaskSemPost()</p> <p>释放任务信号量,虽然只有拥有任务信号量的任务才可以等待该任务信号量,但是其他所有的任务或者中断都可以向该任务释放信号量.</p> <table><thead><tr><th>参数</th> <th>含义</th></tr></thead> <tbody><tr><td>*p_tcb</td> <td>目标任务TCB</td></tr> <tr><td>opt</td> <td>选项</td></tr> <tr><td>*p_err</td> <td>返回错误类型</td></tr></tbody></table> <table><thead><tr><th>选项</th> <th>功能</th></tr></thead> <tbody><tr><td>OS_OPT_POST_NONE</td> <td>没有选项</td></tr> <tr><td>OS_OPT_POST_NO_SCHED</td> <td>不调用调度程序</td></tr></tbody></table> <table><thead><tr><th>错误类型</th> <th>含义</th></tr></thead> <tbody><tr><td>OS_ERR_INT_Q_FULL</td> <td>延迟中断后队列已满</td></tr> <tr><td>OS_ERR_OPT_INVALID</td> <td>指定的选项无效</td></tr> <tr><td>OS_ERR_OS_NOT_RUNNING</td> <td>uC/OS尚未运行</td></tr> <tr><td>OS_ERR_SEM_OVF</td> <td>信号量计数溢出</td></tr> <tr><td>OS_ERR_STATE_INVALID</td> <td>任务处于无效状态</td></tr> <tr><td>OS_ERR_NONE</td> <td>无错误</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code>OS_SEM_CTR <span class="token function">OSTaskSemPost</span><span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span> <span class="token comment">//目标任务</span>
						 OS_OPT opt<span class="token punctuation">,</span> <span class="token comment">//选项</span>
						 OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
	OS_SEM_CTR ctr<span class="token punctuation">;</span>
	CPU_TS ts<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">OS_SAFETY_CRITICAL</span><span class="token comment">//如果启用(默认禁用)了安全检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_err <span class="token operator">==</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果 p_err 为空</span>
	<span class="token punctuation">{</span>
		<span class="token function">OS_SAFETY_CRITICAL_EXCEPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行安全检测异常函数</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ARG_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用(默认启用)了参数检测功能</span></span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token comment">//根据选项分类处理</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">case</span> OS_OPT_POST_NONE<span class="token operator">:</span> <span class="token comment">//如果选项在预期之内</span>
		<span class="token keyword">case</span> OS_OPT_POST_NO_SCHED<span class="token operator">:</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果选项超出预期</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_OPT_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;选项非法&quot;</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	ts <span class="token operator">=</span> <span class="token function">OS_TS_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取时间戳</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ISR_POST_DEFERRED_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了中断延迟发布</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果该函数是在中断中被调用</span>
	<span class="token punctuation">{</span>
		<span class="token function">OS_IntQPost</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OBJ_TYPE<span class="token punctuation">)</span>OS_OBJ_TYPE_TASK_SIGNAL<span class="token punctuation">,</span> <span class="token comment">//将该信号量发布到中断消息队列</span>
					<span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p_tcb<span class="token punctuation">,</span>
					<span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_MSG_SIZE<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_FLAGS <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>CPU_TS <span class="token punctuation">)</span>ts<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(尚未发布)</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	
    <span class="token comment">//调用OS_TaskSemPost()函数将信号量发布到任务中</span>
    ctr <span class="token operator">=</span> <span class="token function">OS_TaskSemPost</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">,</span> <span class="token comment">//将信号量按照普通方式处理</span>
                         opt<span class="token punctuation">,</span>
                         ts<span class="token punctuation">,</span>
                         p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token punctuation">(</span>ctr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回信号的当前计数值</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>释放任务信号量函数的使用实例.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">OSTaskSemPost</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>AppTaskPendTCB<span class="token punctuation">,</span> <span class="token comment">//目标任务</span>
			  <span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>OS_OPT_POST_NONE<span class="token punctuation">,</span> <span class="token comment">//没选项要求</span>
			  <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><p>在释放任务信号量的时候,系统首先判断目标任务的状态,只有处于等待状态并且等待的是任务信号量那就调用<code>OS_Post()</code>函数让等待的任务就绪(如果内核对象信号量的话,还会让任务脱离等待列表),所以任务信号量的操作是非常高效的;如果没有处于等待状态或者等待的不是任务信号量,那就直接将任务控制块的元素<code>SemCtr</code>加1.最后返回任务信号量计数值.</p></li> <li><p>其实,不管是否启用了中断延迟发布,最终都是调用<code>OS_TaskSemPost()</code>函数进行释放任务信号量.只是启用了中断延迟发布的释放过程会比较曲折,中间会有许多插曲,这是中断管理范畴的内容,留到后面再作介绍.在<code>OS_TaskSemPost()</code>函数中,又会调用<code>OS_Post()</code>函数释放内核对象.<code>OS_Post()</code> 函数是一个底层的释放(发布)函数,它不仅仅用来释放(发布)任务信号量,还可以释放信号量,互斥信号量,消息队列,事件标志组或任务消息队列.</p></li></ul></li> <li><p>获取任务信号量函数OSTaskSemPend()</p> <p>用于获取一个任务信号量,参数中没有指定某个任务去获取信号量,实际上就是当前运行任务获取它自己拥有的任务信号量.</p> <table><thead><tr><th>参数</th> <th>含义</th></tr></thead> <tbody><tr><td>timeout</td> <td>等待超时时间</td></tr> <tr><td>opt</td> <td>选项</td></tr> <tr><td>*p_ts</td> <td>时间戳</td></tr> <tr><td>*p_err</td> <td>返回错误类型</td></tr></tbody></table> <table><thead><tr><th>选项</th> <th>功能</th></tr></thead> <tbody><tr><td>OS_OPT_PEND_BLOCKING</td> <td>等待</td></tr> <tr><td>OS_OPT_PEND_NON_BLOCKING</td> <td>不等待</td></tr></tbody></table> <table><thead><tr><th>错误类型</th> <th>含义</th></tr></thead> <tbody><tr><td>OS_ERR_PEND_ABORT</td> <td>获取信号量已中止</td></tr> <tr><td>OS_ERR_OPT_INVALID</td> <td>指定选项无效</td></tr> <tr><td>OS_ERR_OS_NOT_RUNNING</td> <td>uC/OS尚未运行</td></tr> <tr><td>OS_ERR_PEND_ISR</td> <td>从ISR调用了此函数</td></tr> <tr><td>OS_ERR_PEND_WOULD_BLOCK</td> <td>任务处于无效状态</td></tr> <tr><td>OS_ERR_SCHED_LOCKED</td> <td>调度程序已锁定</td></tr> <tr><td>OS_ERR_STATUS_INVALID</td> <td>状态无效</td></tr> <tr><td>OS_ERR_TIMEOUT</td> <td>超时</td></tr> <tr><td>OS_ERR_NONE</td> <td>无错误</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code>OS_SEM_CTR <span class="token function">OSTaskSemPend</span> <span class="token punctuation">(</span>OS_TICK timeout<span class="token punctuation">,</span> <span class="token comment">//等待超时时间</span>
						  OS_OPT opt<span class="token punctuation">,</span> <span class="token comment">//选项</span>
						  CPU_TS <span class="token operator">*</span>p_ts<span class="token punctuation">,</span> <span class="token comment">//返回时间戳</span>
						  OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
	OS_SEM_CTR ctr<span class="token punctuation">;</span>
	<span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用到临界段(在关/开中断时)时必须用到该宏</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">OS_SAFETY_CRITICAL</span><span class="token comment">//如果启用了安全检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_err <span class="token operator">==</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果错误类型实参为空</span>
	<span class="token punctuation">{</span>
		<span class="token function">OS_SAFETY_CRITICAL_EXCEPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行安全检测异常函数</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_CALLED_FROM_ISR_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了中断中非法调用检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果该函数在中断中被调用</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_PEND_ISR<span class="token punctuation">;</span> <span class="token comment">//返回错误类型为&quot;在中断中等待&quot;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ARG_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了参数检测</span></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token comment">//根据选项分类处理</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OS_OPT_PEND_BLOCKING<span class="token operator">:</span> <span class="token comment">//如果选项在预期内</span>
        <span class="token keyword">case</span> OS_OPT_PEND_NON_BLOCKING<span class="token operator">:</span>
    		<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//直接跳出</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果选项超出预期</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_OPT_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;选项非法&quot;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果 p_ts 非空</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_ts <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_TS <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//清零(初始化)p_ts</span>
    <span class="token punctuation">}</span>

    <span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>OSTCBCurPtr<span class="token operator">-&gt;</span>SemCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果任务信号量当前可用</span>
    <span class="token punctuation">{</span>
        OSTCBCurPtr<span class="token operator">-&gt;</span>SemCtr<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">//信号量计数器减 1</span>
        ctr <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>SemCtr<span class="token punctuation">;</span> <span class="token comment">//获取信号量的当前计数值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果 p_ts 非空</span>
        <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_ts <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>TS<span class="token punctuation">;</span> <span class="token comment">//返回信号量被发布的时间戳</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_PROFILE_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span></span>
        OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTime <span class="token operator">=</span> <span class="token function">OS_TS_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> OSTCBCurPtr<span class="token operator">-&gt;</span>TS<span class="token punctuation">;</span> <span class="token comment">//更新任务等待</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTimeMax <span class="token operator">&lt;</span> OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTime<span class="token punctuation">)</span> <span class="token comment">//任务信号量的</span>
        <span class="token punctuation">{</span>
            OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTimeMax <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTime<span class="token punctuation">;</span> <span class="token comment">//最长时间记录.</span>
        <span class="token punctuation">}</span><span class="token comment">//如果启用任务统计的宏,计算任务信号量从被提交到获取所用时间及最大时间</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
        <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;无错误&quot;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>ctr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回信号量的当前计数值</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 如果任务信号量当前不可用 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opt <span class="token operator">&amp;</span> OS_OPT_PEND_NON_BLOCKING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果选择了不阻塞任务</span>
    <span class="token punctuation">{</span>
        <span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
        <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_PEND_WOULD_BLOCK<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;缺乏阻塞&quot;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果选择了阻塞任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>OSSchedLockNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果调度器被锁</span>
        <span class="token punctuation">{</span>
            <span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_SCHED_LOCKED<span class="token punctuation">;</span><span class="token comment">//错误类型为&quot;调度器被锁&quot;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 如果调度器未被锁 */</span>
    <span class="token function">OS_CRITICAL_ENTER_CPU_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//锁调度器,重开中断</span>
    <span class="token function">OS_Pend</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_PEND_DATA <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//阻塞任务,等待信号量.</span>
    <span class="token punctuation">(</span>OS_PEND_OBJ <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//不需插入等待列表.</span>
    <span class="token punctuation">(</span>OS_STATE <span class="token punctuation">)</span>OS_TASK_PEND_ON_TASK_SEM<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开调度器(无调度)</span>

    <span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调度任务</span>
    <span class="token comment">/* 任务获得信号量后得以继续运行 */</span>
    <span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>OSTCBCurPtr<span class="token operator">-&gt;</span>PendStatus<span class="token punctuation">)</span> <span class="token comment">//根据任务的等待状态分类处理</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OS_STATUS_PEND_OK<span class="token operator">:</span> <span class="token comment">//如果任务成功获得信号量</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//返回信号量被发布的时间戳</span>
            <span class="token punctuation">{</span>
                <span class="token operator">*</span>p_ts <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>TS<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_PROFILE_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//更新最长等待时间记录</span></span>
                OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTime <span class="token operator">=</span> <span class="token function">OS_TS_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> OSTCBCurPtr<span class="token operator">-&gt;</span>TS<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTimeMax <span class="token operator">&lt;</span> OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTime<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTimeMax <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>SemPendTime<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    		<span class="token punctuation">}</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;无错误&quot;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
    	<span class="token keyword">case</span> OS_STATUS_PEND_ABORT<span class="token operator">:</span> <span class="token comment">//如果等待被中止</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//返回被终止时的时间戳</span>
            <span class="token punctuation">{</span>
                <span class="token operator">*</span>p_ts <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>TS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_PEND_ABORT<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;等待被中止&quot;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
    	<span class="token keyword">case</span> OS_STATUS_PEND_TIMEOUT<span class="token operator">:</span> <span class="token comment">//如果等待超时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//返回时间戳为 0</span>
            <span class="token punctuation">{</span>
            <span class="token operator">*</span>p_ts <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_TS <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIMEOUT<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;等待超时&quot;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果等待状态超出预期</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_STATUS_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;状态非法&quot;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
    <span class="token punctuation">}</span>
    ctr <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>SemCtr<span class="token punctuation">;</span> <span class="token comment">//获取信号量的当前计数值</span>
    <span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>ctr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回信号量的当前计数值</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br></div></div><p>获取任务信号量函数的使用实例.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">OSTaskSemPend</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//无期限等待</span>
			   <span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>OS_OPT_PEND_BLOCKING<span class="token punctuation">,</span> <span class="token comment">//如果信号量不可用就等待</span>
			   <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ts<span class="token punctuation">,</span> <span class="token comment">//获取信号量被发布的时间戳</span>
			   <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在调用该函数的时候,系统先判断任务信号量是否可用,即检查任务信号量的计数值是否大于0,如果大于 0,即表示可用,这个时候获取信号量,即将计数值减1后直接返回.如果信号量不可用,且当调度器没有被锁住时,用户希望在任务信号量不可用的时候进行阻塞任务以等待任务信号量可用,那么系统就会调用<code>OS_Pend()</code>函数将任务脱离就绪列表,如果用户有指定超时时间,系统还要将该任务插入节拍列表.注意:此处系统并没有将任务插入等待列表.然后切换任务,处于就绪列表中最高优先级的任务通过任务调度获得CPU使用权,等到出现任务信号量被释放,任务等待任务信号量被强制停止,等待超时等情况,任务会从阻塞中恢复,等待任务信号量的任务重新获得CPU使用权,返回相关错误代码和任务信号量计数值,用户可以根据返回的错误知道任务退出等待状态的情况.</p></li></ul> <h2 id="任务信号量实验"><a href="#任务信号量实验" class="header-anchor">#</a> 任务信号量实验</h2> <h3 id="任务信号量代替二值信号量"><a href="#任务信号量代替二值信号量" class="header-anchor">#</a> 任务信号量代替二值信号量</h3> <p>任务通知代替消息队列是在μC/OS中创建了两个任务,其中一个任务是用于接收任务信号量,另一个任务发送任务信号量.两个任务独立运行,发送任务信号量的任务是通过检测按键的按下情况发送,等待任务在任务信号量中没有可用的信号量之前就一直等待,获取到信号量以后就继续执行,这样子是为了代替二值信号量,任务同步成功则继续执行,然后在串口调试助手里将运行信息打印出来.</p> <ol><li><p>定义任务空间栈的大小以及任务栈数组,任务控制块和优先级.</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261105366.png" alt="任务信号量代替二值信号量实验1_1"></p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261106310.png" alt="任务信号量代替二值信号量实验1_2"></p></li> <li><p>定义任务函数</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261106466.png" alt="任务信号量代替二值信号量实验2"></p></li> <li><p>任务启动函数编写</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261106026.png" alt="任务信号量代替二值信号量实验3"></p></li> <li><p>结果现象</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261106437.png" alt="任务信号量代替二值信号量实验4"></p></li></ol> <h3 id="任务信号量代替计数信号量"><a href="#任务信号量代替计数信号量" class="header-anchor">#</a> 任务信号量代替计数信号量</h3> <p>任务通知代替计数信号量是基于计数信号量实验修改而来,模拟停车场工作运行.并且在μC/OS中创建了两个任务:一个是获取信号量任务,一个是发送信号量任务,两个任务独立运行.按下WKUP按键计数信号量+1,每秒计数信号量-1.</p> <ol><li><p>定义任务空间栈的大小以及任务栈数组,任务控制块和优先级.</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261109876.png" alt="任务信号量代替计数信号量实验1_1"></p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261109175.png" alt="任务信号量代替计数信号量实验1_2"></p></li> <li><p>定义任务函数</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261109866.png" alt="任务信号量代替计数信号量实验2"></p></li> <li><p>任务启动函数编写</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261106390.png" alt="任务信号量代替计数信号量实验3"></p></li> <li><p>结果现象</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261106259.png" alt="任务信号量代替计数信号量实验4"></p></li></ol> <h1 id="任务消息队列"><a href="#任务消息队列" class="header-anchor">#</a> 任务消息队列</h1> <h2 id="任务消息队列的基本概念"><a href="#任务消息队列的基本概念" class="header-anchor">#</a> 任务消息队列的基本概念</h2> <ul><li><p>任务消息队列跟任务信号量一样,均隶属于某一个特定任务,不需单独创建,任务在则任务消息</p> <p>队列在,只有该任务才可以获取(接收)这个任务消息队列的消息,其他任务只能给这个任务消</p> <p>息队列发送消息,却不能获取.任务消息队列与前面讲解的(普通)消息队列极其相似,只是任</p> <p>务消息队列已隶属于一个特定任务,所以它不具有等待列表,在操作的过程中省去了等待任务插</p> <p>入和移除列表的动作,所以工作原理相对更简单一点,效率也比较高一些.</p></li> <li><p>通过对任务消息队列的合理使用,可以在一定场合下替代μC/OS的消息队列,用户只需向任务内</p> <p>部的消息队列发送一个消息而不用通过外部的消息队列进行发送,这样子处理就会很方便并且</p> <p>更加高效,当然,凡事都有利弊,任务消息队列虽然处理更快,RAM开销更小,但也有限制:只</p> <p>能指定消息发送的对象,有且只有一个任务接收消息;而内核对象的消息队列则没有这个限制,</p> <p>用户在发送消息的时候,可以采用广播消息的方式,让所有等待该消息的任务都获取到消息.</p></li> <li><p>在实际任务间的通信中,一个或多个任务发送一个消息给另一个任务是非常常见的,而一个任务</p> <p>给多个任务发送消息的情况相对比较少,前者就很适合采用任务消息队列进行传递消息,如果任</p> <p>务消息队列可以满足设计需求,那么尽量不要使用普通消息队列,这样子设计的系统会更加高</p> <p>效.</p></li> <li><p>消息队列(内核对象)是用结构体OS_Q来管理的,包含了管理消息的元素MsgQ和管理等待列</p> <p>表的元素PendList等.而任务消息队列的结构体成员变量就少了PendList,因为等待任务消息队</p> <p>列只有拥有任务消息队列本身的任务才可以进行获取,故任务消息队列不需要等待列表的相关</p> <p>数据结构,</p></li> <li><p>想要使用任务消息队列,就必须将<code>OS_CFG_TASK_Q_EN</code>宏定义配置为1,该宏定义位于os_cfg.h文件中.</p></li> <li><p>任务消息队列数据结构</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">os_msg_q</span><span class="token punctuation">{</span>
    OS_MSG <span class="token operator">*</span>InPtr<span class="token punctuation">;</span>
    OS_MSG <span class="token operator">*</span>OutPtr<span class="token punctuation">;</span> <span class="token comment">//*InPtr和*OutPtr是任务消息队列中进出消息指针</span>
    OS_MSG_QTY NbrEntriesSize<span class="token punctuation">;</span> <span class="token comment">//任务消息队列中最大可用的消息个数,在创建任务的时候由用户指定这个值的大小</span>
    OS_MSG_QTY NbrEntries<span class="token punctuation">;</span> <span class="token comment">//记录任务消息队列中当前的消息个数,每当发送一个消息到任务消息队列的时候,若任务没有在等待该消息,那么新发送的消息被插入任务消息队列后此值加1,NbrEntries的大小不能超过NbrEntriesSize</span>
    OS_MSG_QTY NbrEntriesMax<span class="token punctuation">;</span> <span class="token comment">//记录任务消息队列最多的时候拥有的消息个数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul> <h2 id="任务消息队列的函数"><a href="#任务消息队列的函数" class="header-anchor">#</a> 任务消息队列的函数</h2> <table><thead><tr><th>函数名称</th> <th>函数作用</th></tr></thead> <tbody><tr><td>OStaskQPost()</td> <td>发送任务消息队列</td></tr> <tr><td>OSTaskQpend()</td> <td>获取任务消息队列</td></tr></tbody></table> <ul><li><p>任务消息队列发送函数OSTaskQPost()</p> <p>发送任务消息队列,参数中有指向消息要发送给的任务控制块的指针,任何任务都可以发送消息给拥有任务消息队列的任务(任务在被创建的时候,要设置参数 q_size大于 0).</p> <table><thead><tr><th>参数</th> <th>含义</th></tr></thead> <tbody><tr><td>*p_tcb</td> <td>目标任务TCB</td></tr> <tr><td>*p_void</td> <td>消息内容地址</td></tr> <tr><td>msg_size</td> <td>消息长度</td></tr> <tr><td>opt</td> <td>选项</td></tr> <tr><td>*p_err</td> <td>返回错误类型</td></tr></tbody></table> <table><thead><tr><th>选项</th> <th>功能</th></tr></thead> <tbody><tr><td>OS_OPT_POST_FIFO</td> <td>先进先出</td></tr> <tr><td>OS_OPT_POST_LIFO</td> <td>后进先出</td></tr> <tr><td>OS_OPT_POST_NO_SCHED</td> <td>不在发布后运行调度程序</td></tr></tbody></table> <table><thead><tr><th>错误类型</th> <th>含义</th></tr></thead> <tbody><tr><td>OS_ERR_INT_Q_FULL</td> <td>延迟中断后队列已满</td></tr> <tr><td>OS_ERR_MSG_POOL_EMPTY</td> <td>延迟中断后队列已满</td></tr> <tr><td>OS_ERR_OPT_INVALID</td> <td>栈已空</td></tr> <tr><td>OS_ERR_OS_NOT_RUNNING</td> <td>uC/OS尚未运行</td></tr> <tr><td>OS_ERR_Q_MAX</td> <td>消息队列已满</td></tr> <tr><td>OS_ERR_STATE_INVALID</td> <td>任务无效</td></tr> <tr><td>OS_ERR_NONE</td> <td>无错误</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_Q_EN <span class="token operator">&gt;</span> <span class="token number">0u</span> </span><span class="token comment">//如果启用了任务消息队列</span></span>
<span class="token keyword">void</span> <span class="token function">OSTaskQPost</span><span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span> <span class="token comment">//目标任务</span>
                 <span class="token keyword">void</span> <span class="token operator">*</span>p_void<span class="token punctuation">,</span> <span class="token comment">//消息内容地址</span>
                 OS_MSG_SIZE msg_size<span class="token punctuation">,</span> <span class="token comment">//消息长度</span>
                 OS_OPT opt<span class="token punctuation">,</span> <span class="token comment">//选项</span>
                 OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    CPU_TS ts<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">OS_SAFETY_CRITICAL</span><span class="token comment">//如果启用(默认禁用)了安全检测</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p_err <span class="token operator">==</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果错误类型实参为空</span>
    <span class="token punctuation">{</span>
        <span class="token function">OS_SAFETY_CRITICAL_EXCEPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行安全检测异常函数</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ARG_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了参数检测</span></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token comment">//根据选项分类处理</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OS_OPT_POST_FIFO<span class="token operator">:</span> <span class="token comment">//如果选项在预期内</span>
        <span class="token keyword">case</span> OS_OPT_POST_LIFO<span class="token operator">:</span>
        <span class="token keyword">case</span> OS_OPT_POST_FIFO <span class="token operator">|</span> OS_OPT_POST_NO_SCHED<span class="token operator">:</span>
        <span class="token keyword">case</span> OS_OPT_POST_LIFO <span class="token operator">|</span> OS_OPT_POST_NO_SCHED<span class="token operator">:</span>
    		<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//直接跳出</span>
		<span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果选项超出预期</span>
		    <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_OPT_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;选项非法&quot;</span>
		    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    ts <span class="token operator">=</span> <span class="token function">OS_TS_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取时间戳</span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ISR_POST_DEFERRED_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了中断延迟发布</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果该函数在中断中被调用</span>
    <span class="token punctuation">{</span>
        <span class="token function">OS_IntQPost</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OBJ_TYPE<span class="token punctuation">)</span>OS_OBJ_TYPE_TASK_MSG<span class="token punctuation">,</span> <span class="token comment">//将消息先发布到中断消息队列</span>
                    <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p_tcb<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p_void<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_MSG_SIZE<span class="token punctuation">)</span>msg_size<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_FLAGS <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>opt<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>CPU_TS <span class="token punctuation">)</span>ts<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token function">OS_TaskQPost</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">,</span> <span class="token comment">//将消息直接发布</span>
                 p_void<span class="token punctuation">,</span>
                 msg_size<span class="token punctuation">,</span>
                 opt<span class="token punctuation">,</span>
                 ts<span class="token punctuation">,</span>
                 p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div></li> <li><p>任务消息队列获取函数OSTaskQPend()</p> <p>于获取一个任务消息队列,函数的参数中没有指定哪个任务获取任务消息,实际上就是当前执行的任务,当任务调用了这个函数就表明这个任务需要获取任务消息.</p> <table><thead><tr><th>参数</th> <th>含义</th></tr></thead> <tbody><tr><td>timeout</td> <td>等待期限</td></tr> <tr><td>opt</td> <td>选项</td></tr> <tr><td>*p_msg_size</td> <td>返回消息长度</td></tr> <tr><td>*p_ts</td> <td>返回时间戳</td></tr> <tr><td>*p_err</td> <td>返回错误类型的指针</td></tr></tbody></table> <table><thead><tr><th>选项</th> <th>功能</th></tr></thead> <tbody><tr><td>OS_OPT_PEND_BLOCKING</td> <td>等待</td></tr> <tr><td>OS_OPT_PEND_NON_BLOCKING</td> <td>不等待</td></tr></tbody></table> <table><thead><tr><th>错误类型</th> <th>含义</th></tr></thead> <tbody><tr><td>OS_ERR_OPT_INVALID</td> <td>选项无效</td></tr> <tr><td>OS_ERR_OS_NOT_RUNNING</td> <td>uC/OS尚未运行</td></tr> <tr><td>OS_ERR_PEND_ABORT</td> <td>获取信号量已终止</td></tr> <tr><td>OS_ERR_PEND_ISR</td> <td>从ISR调用了此函数</td></tr> <tr><td>OS_ERR_PEND_WOULD_BLOCK</td> <td>任务处于无效状态</td></tr> <tr><td>OS_ERR_PTR_INVALID</td> <td>p_msg_size为空</td></tr> <tr><td>OS_ERR_SCHED_LOCKED</td> <td>调度任务已锁定</td></tr> <tr><td>OS_ERR_TIMEOUT</td> <td>超时</td></tr> <tr><td>OS_ERR_NONE</td> <td>无错误</td></tr></tbody></table> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_Q_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了任务消息队列</span></span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">OSTaskQPend</span><span class="token punctuation">(</span>OS_TICK timeout<span class="token punctuation">,</span> <span class="token comment">//等待期限(单位:时钟节拍)</span>
				  OS_OPT opt<span class="token punctuation">,</span> <span class="token comment">//选项</span>
				  OS_MSG_SIZE <span class="token operator">*</span>p_msg_size<span class="token punctuation">,</span> <span class="token comment">//返回消息长度</span>
				  CPU_TS <span class="token operator">*</span>p_ts<span class="token punctuation">,</span> <span class="token comment">//返回时间戳</span>
				  OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
	OS_MSG_Q <span class="token operator">*</span>p_msg_q<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>p_void<span class="token punctuation">;</span>
	<span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用到临界段(在关/开中断时)时必须用到该宏</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">OS_SAFETY_CRITICAL</span><span class="token comment">//如果启用(默认禁用)了安全检测</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p_err <span class="token operator">==</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果错误类型实参为空</span>
    <span class="token punctuation">{</span>
        <span class="token function">OS_SAFETY_CRITICAL_EXCEPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行安全检测异常函数</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_CALLED_FROM_ISR_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了中断中非法调用检测</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果该函数在中断中被调用</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_PEND_ISR<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;在中断中中止等待&quot;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ARG_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了参数检测</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p_msg_size <span class="token operator">==</span> <span class="token punctuation">(</span>OS_MSG_SIZE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果 p_msg_size 为空</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_PTR_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;指针不可用&quot;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token comment">//根据选项分类处理</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OS_OPT_PEND_BLOCKING<span class="token operator">:</span> <span class="token comment">//如果选项在预期内</span>
        <span class="token keyword">case</span> OS_OPT_PEND_NON_BLOCKING<span class="token operator">:</span>
    		<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//直接跳出</span>

        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果选项超出预期</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_OPT_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;选项非法&quot;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果 p_ts 非空</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_ts <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_TS <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//初始化(清零)p_ts,待用于返回时间戳</span>
    <span class="token punctuation">}</span>

    <span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
    p_msg_q <span class="token operator">=</span> <span class="token operator">&amp;</span>OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQ<span class="token punctuation">;</span><span class="token comment">//获取当前任务的消息队列</span>
    p_void <span class="token operator">=</span> <span class="token function">OS_MsgQGet</span><span class="token punctuation">(</span>p_msg_q<span class="token punctuation">,</span> <span class="token comment">//从队列里获取一个消息</span>
    					p_msg_size<span class="token punctuation">,</span>
                        p_ts<span class="token punctuation">,</span>
                        p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p_err <span class="token operator">==</span> OS_ERR_NONE<span class="token punctuation">)</span> <span class="token comment">//如果获取消息成功</span>
    <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_PROFILE_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTime <span class="token operator">=</span> <span class="token function">OS_TS_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token operator">*</span>p_ts<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTimeMax <span class="token operator">&lt;</span> OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTime<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTimeMax <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>p_void<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回消息内容</span>
<span class="token punctuation">}</span>
    <span class="token comment">/* 如果获取消息不成功(队列里没有消息) */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opt <span class="token operator">&amp;</span> OS_OPT_PEND_NON_BLOCKING<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果选择了不阻塞任务</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_PEND_WOULD_BLOCK<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;缺乏阻塞&quot;</span>
        <span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果选择了阻塞任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>OSSchedLockNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果调度器被锁</span>
        <span class="token punctuation">{</span>
            <span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_SCHED_LOCKED<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;调度器被锁&quot;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回 0(有错误),停止执行</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 如果调度器未被锁 */</span>
    <span class="token function">OS_CRITICAL_ENTER_CPU_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//锁调度器,重开中断</span>
    <span class="token function">OS_Pend</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_PEND_DATA <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//阻塞当前任务,等待消息</span>
    <span class="token punctuation">(</span>OS_PEND_OBJ <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>OS_STATE <span class="token punctuation">)</span>OS_TASK_PEND_ON_TASK_Q<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解锁调度器(无调度)</span>

    <span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调度任务</span>
    <span class="token comment">/* 当前任务(获得消息队列的消息)得以继续运行 */</span>
    <span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>OSTCBCurPtr<span class="token operator">-&gt;</span>PendStatus<span class="token punctuation">)</span> <span class="token comment">//根据任务的等待状态分类处理</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OS_STATUS_PEND_OK<span class="token operator">:</span> <span class="token comment">//如果任务已成功获得消息</span>
            p_void <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>MsgPtr<span class="token punctuation">;</span> <span class="token comment">//提取消息内容地址</span>
            <span class="token operator">*</span>p_msg_size <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>MsgSize<span class="token punctuation">;</span> <span class="token comment">//提取消息长度</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果 p_ts 非空</span>
            <span class="token punctuation">{</span>
            	<span class="token operator">*</span>p_ts <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>TS<span class="token punctuation">;</span> <span class="token comment">//获取任务等到消息时的时间戳</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_PROFILE_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span></span>

    			OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTime <span class="token operator">=</span> <span class="token function">OS_TS_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> OSTCBCurPtr<span class="token operator">-&gt;</span>TS<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTimeMax <span class="token operator">&lt;</span> OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTime<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTimeMax <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>MsgQPendTime<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    		<span class="token punctuation">}</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;无错误&quot;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_STATUS_PEND_ABORT<span class="token operator">:</span> <span class="token comment">//如果等待被中止</span>
            p_void <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//返回消息内容为空</span>
            <span class="token operator">*</span>p_msg_size <span class="token operator">=</span> <span class="token punctuation">(</span>OS_MSG_SIZE<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//返回消息大小为 0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果 p_ts 非空</span>
            <span class="token punctuation">{</span>
                <span class="token operator">*</span>p_ts <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_TS <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//清零 p_ts</span>
            <span class="token punctuation">}</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_PEND_ABORT<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;等待被中止&quot;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
        <span class="token keyword">case</span> OS_STATUS_PEND_TIMEOUT<span class="token operator">:</span> <span class="token comment">//如果等待超时</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//或者任务状态超出预</span>
            p_void <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//返回消息内容为空</span>
            <span class="token operator">*</span>p_msg_size <span class="token operator">=</span> <span class="token punctuation">(</span>OS_MSG_SIZE<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//返回消息大小为 0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p_ts <span class="token operator">!=</span> <span class="token punctuation">(</span>CPU_TS <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果 p_ts 非空</span>
            <span class="token punctuation">{</span>
            <span class="token operator">*</span>p_ts <span class="token operator">=</span> OSTCBCurPtr<span class="token operator">-&gt;</span>TS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIMEOUT<span class="token punctuation">;</span> <span class="token comment">//错误类为&quot;等待超时&quot;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
	<span class="token punctuation">}</span>
	<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>p_void<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回消息内容地址</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br></div></div></li></ul> <h2 id="任务消息队列实验"><a href="#任务消息队列实验" class="header-anchor">#</a> 任务消息队列实验</h2> <p>任务通知代替消息队列是在μC/OS中创建了两个任务,其中一个任务是用于接收任务消息,另一个任务发送任务消息.两个任务独立运行,发送消息任务每秒发送一次任务消息,接收任务在就一直在等待消息,一旦获取到消息通知就通过串口发送出来.</p> <ol><li><p>定义任务空间栈的大小以及任务栈数组,任务控制块和优先级.</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261106006.png" alt="任务消息队列实验1_1"></p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261107304.png" alt="任务消息队列实验1_2"></p></li> <li><p>定义任务函数</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261107192.png" alt="任务消息队列实验2"></p></li> <li><p>任务启动函数编写</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261107871.png" alt="任务消息队列实验3"></p></li> <li><p>结果现象</p> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/202302261109041.png" alt="任务消息队列实验4"></p></li></ol></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023/3/16 13:13:56</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-2a01419c data-v-2a01419c><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-2a01419c><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-2a01419c></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-2a01419c></path></svg></div><!----><div class="RibbonAnimation"></div></div></div>
    <script src="/assets/js/app.88e14013.js" defer></script><script src="/assets/js/3.a7922583.js" defer></script><script src="/assets/js/1.890579b8.js" defer></script><script src="/assets/js/16.671f3930.js" defer></script>
  </body>
</html>
