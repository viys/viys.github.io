<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>μC/OSIII学习day6 | viys</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="favicon.png">
    <script>
          var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?b0aae218897fa9d8a9f76e9a77e0b3c6";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
          })();
        </script>
    <meta name="description" content="温柔才是宝藏，你也是">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="msvalidate.01" content="995BE321E828B6205FA316BCC0116630">
    
    <link rel="preload" href="/assets/css/0.styles.1d5d80ee.css" as="style"><link rel="preload" href="/assets/js/app.88e14013.js" as="script"><link rel="preload" href="/assets/js/3.a7922583.js" as="script"><link rel="preload" href="/assets/js/1.890579b8.js" as="script"><link rel="preload" href="/assets/js/24.7c4cca11.js" as="script"><link rel="prefetch" href="/assets/js/10.0c84f94a.js"><link rel="prefetch" href="/assets/js/11.8a8b6d41.js"><link rel="prefetch" href="/assets/js/12.00b30763.js"><link rel="prefetch" href="/assets/js/13.e38f5f8a.js"><link rel="prefetch" href="/assets/js/14.02144b91.js"><link rel="prefetch" href="/assets/js/15.67b3306f.js"><link rel="prefetch" href="/assets/js/16.671f3930.js"><link rel="prefetch" href="/assets/js/17.09e62461.js"><link rel="prefetch" href="/assets/js/18.1843f437.js"><link rel="prefetch" href="/assets/js/19.86b824eb.js"><link rel="prefetch" href="/assets/js/20.7066bbd1.js"><link rel="prefetch" href="/assets/js/21.4d141867.js"><link rel="prefetch" href="/assets/js/22.df4be56b.js"><link rel="prefetch" href="/assets/js/23.5048a92e.js"><link rel="prefetch" href="/assets/js/25.1c23ab8a.js"><link rel="prefetch" href="/assets/js/26.a4863835.js"><link rel="prefetch" href="/assets/js/27.53863764.js"><link rel="prefetch" href="/assets/js/28.6a163b38.js"><link rel="prefetch" href="/assets/js/29.f54ae3de.js"><link rel="prefetch" href="/assets/js/30.53e19ce6.js"><link rel="prefetch" href="/assets/js/31.9cb47c73.js"><link rel="prefetch" href="/assets/js/32.d0a996fc.js"><link rel="prefetch" href="/assets/js/33.4d4c3f90.js"><link rel="prefetch" href="/assets/js/34.9b00d023.js"><link rel="prefetch" href="/assets/js/35.4a3f555e.js"><link rel="prefetch" href="/assets/js/4.8a2b8ed1.js"><link rel="prefetch" href="/assets/js/5.fa3e6dfb.js"><link rel="prefetch" href="/assets/js/6.298b5948.js"><link rel="prefetch" href="/assets/js/7.47c95cae.js"><link rel="prefetch" href="/assets/js/8.f0271449.js"><link rel="prefetch" href="/assets/js/9.50e96886.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1d5d80ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1db74182><div data-v-1db74182><div id="loader-wrapper" class="loading-wrapper" data-v-57c58703 data-v-1db74182 data-v-1db74182><div class="loader-main" data-v-57c58703><div data-v-57c58703></div><div data-v-57c58703></div><div data-v-57c58703></div><div data-v-57c58703></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-5cb9a64e data-v-1db74182 data-v-1db74182><h3 class="title" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e>viys</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><input type="password" value="" data-v-5cb9a64e> <span data-v-5cb9a64e>Konck! Knock!</span> <button data-v-5cb9a64e>OK</button></label> <div class="footer" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><span data-v-5cb9a64e><i class="iconfont reco-theme" data-v-5cb9a64e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-5cb9a64e>vuePress-theme-reco</a></span> <span data-v-5cb9a64e><i class="iconfont reco-copyright" data-v-5cb9a64e></i> <a data-v-5cb9a64e><span data-v-5cb9a64e>viys</span>
            
          <span data-v-5cb9a64e>2022 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-1db74182><div data-v-1db74182><div id="smart" class="wrapper-page" style="background-image:url(/images/5.jpg);background-position-x:center;background-position-y:center;background-size:cover;background-repeat-x:no-repeat;background-repeat-y:no-repeat;" data-v-1db74182><header class="navbar" data-v-1db74182><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/mylogo.png" alt="viys" class="logo"> <span class="site-name">viys</span></a> <div class="links"><div id="dayNightSwitch" class="generalWrapper" data-v-32f44868><a class="click" data-v-32f44868><div class="onOff daySwitch" data-v-32f44868><div class="star star1" data-v-32f44868></div> <div class="star star2" data-v-32f44868></div> <div class="star star3" data-v-32f44868></div> <div class="star star4" data-v-32f44868></div> <div class="star star5" data-v-32f44868></div> <div class="star sky" data-v-32f44868></div> <div class="sunMoon" data-v-32f44868><div class="crater crater1" data-v-32f44868></div> <div class="crater crater2" data-v-32f44868></div> <div class="crater crater3" data-v-32f44868></div> <div class="cloud part1" data-v-32f44868></div> <div class="cloud part2" data-v-32f44868></div></div></div></a></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/项目日志/" class="nav-link"><i class="iconfont undefined"></i>
  项目日志
</a></li><li class="dropdown-item"><!----> <a href="/categories/学习笔记/" class="nav-link"><i class="iconfont undefined"></i>
  学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/进步计划/" class="nav-link"><i class="iconfont undefined"></i>
  进步计划
</a></li><li class="dropdown-item"><!----> <a href="/categories/700实例/" class="nav-link"><i class="iconfont undefined"></i>
  700实例
</a></li><li class="dropdown-item"><!----> <a href="/categories/Terminal/" class="nav-link"><i class="iconfont undefined"></i>
  Terminal
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1db74182></div> <aside class="sidebar" data-v-1db74182><div class="personal-info-wrapper" data-v-03833281 data-v-1db74182><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/avatar_top.png" alt="author-avatar" class="personal-img" data-v-03833281> <h3 class="name" data-v-03833281>
    viys
  </h3> <div class="num" data-v-03833281><div data-v-03833281><h3 data-v-03833281>22</h3> <h6 data-v-03833281>文章</h6></div> <div data-v-03833281><h3 data-v-03833281>21</h3> <h6 data-v-03833281>标签</h6></div></div> <hr data-v-03833281></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/项目日志/" class="nav-link"><i class="iconfont undefined"></i>
  项目日志
</a></li><li class="dropdown-item"><!----> <a href="/categories/学习笔记/" class="nav-link"><i class="iconfont undefined"></i>
  学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/进步计划/" class="nav-link"><i class="iconfont undefined"></i>
  进步计划
</a></li><li class="dropdown-item"><!----> <a href="/categories/700实例/" class="nav-link"><i class="iconfont undefined"></i>
  700实例
</a></li><li class="dropdown-item"><!----> <a href="/categories/Terminal/" class="nav-link"><i class="iconfont undefined"></i>
  Terminal
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-5cb9a64e data-v-1db74182><h3 class="title" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e>μC/OSIII学习day6</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><input type="password" value="" data-v-5cb9a64e> <span data-v-5cb9a64e>Konck! Knock!</span> <button data-v-5cb9a64e>OK</button></label> <div class="footer" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><span data-v-5cb9a64e><i class="iconfont reco-theme" data-v-5cb9a64e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-5cb9a64e>vuePress-theme-reco</a></span> <span data-v-5cb9a64e><i class="iconfont reco-copyright" data-v-5cb9a64e></i> <a data-v-5cb9a64e><span data-v-5cb9a64e>viys</span>
            
          <span data-v-5cb9a64e>2022 - </span>
          2023
        </a></span></div></div></div> <div data-v-1db74182><main class="page"><div class="page-title" style="display:none;"><h1 class="title">μC/OSIII学习day6</h1> <div class="page-info" data-v-0efa1f05><i class="iconfont reco-account" data-v-0efa1f05><span data-v-0efa1f05>viys</span></i> <i class="iconfont reco-date" data-v-0efa1f05><span data-v-0efa1f05>2022-12-07</span></i> <!----> <i class="iconfont reco-tag tags" data-v-0efa1f05><span class="tag-item" data-v-0efa1f05>μC/OS</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block tip"><p class="custom-block-title">介绍</p> <p>任务的删除,任务管理</p></div> <h1 id="任务的删除"><a href="#任务的删除" class="header-anchor">#</a> 任务的删除</h1> <h2 id="μc-os如何实现任务的删除"><a href="#μc-os如何实现任务的删除" class="header-anchor">#</a> μC/OS如何实现任务的删除</h2> <h2 id="任务删除函数"><a href="#任务删除函数" class="header-anchor">#</a> 任务删除函数</h2> <ul><li><p>OSTaskDel()函数</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//删除一个指定的任务(包括自身)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_DEL_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span></span>
<span class="token keyword">void</span> <span class="token function">OSTaskDel</span><span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 不允许删除空闲任务 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> <span class="token operator">&amp;</span>OSIdleTaskTCB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TASK_DEL_IDLE<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/* 删除自己 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		p_tcb <span class="token operator">=</span> OSTCBCurPtr<span class="token punctuation">;</span>
		<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">OS_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* 根据任务的状态来决定删除的动作 */</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>TaskState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> OS_TASK_STATE_RDY<span class="token operator">:</span>
			<span class="token function">OS_RdyListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> OS_TASK_STATE_SUSPENDED<span class="token operator">:</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token comment">/* 任务只是在延时,并没有在任何等待列表 */</span>
		<span class="token keyword">case</span> OS_TASK_STATE_DLY<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_DLY_SUSPENDED<span class="token operator">:</span>
			<span class="token function">OS_TickListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_SUSPENDED<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_TIMEOUT<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_TIMEOUT_SUSPENDED<span class="token operator">:</span>
			<span class="token function">OS_TickListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span><span class="token comment">/* 目前我们还没有实现等待列表,暂时先把这部分代码注释 */</span></span>
	<span class="token comment">/* 看看在等待什么 */</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>PendOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> OS_TASK_PEND_ON_NOTHING<span class="token operator">:</span>
            <span class="token comment">/* 任务信号量和队列没有等待队列,直接退出 */</span>
            <span class="token keyword">case</span> OS_TASK_PEND_ON_TASK_Q<span class="token operator">:</span>
            <span class="token keyword">case</span> OS_TASK_PEND_ON_TASK_SEM<span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">/* 从等待列表移除 */</span>
            <span class="token keyword">case</span> OS_TASK_PEND_ON_FLAG<span class="token operator">:</span>
            <span class="token keyword">case</span> OS_TASK_PEND_ON_MULTI<span class="token operator">:</span>
            <span class="token keyword">case</span> OS_TASK_PEND_ON_MUTEX<span class="token operator">:</span>
            <span class="token keyword">case</span> OS_TASK_PEND_ON_Q<span class="token operator">:</span>
            <span class="token keyword">case</span> OS_TASK_PEND_ON_SEM<span class="token operator">:</span>
                <span class="token function">OS_PendListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">OS_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_STATE_INVALID<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/* 初始化 TCB 为默认值 */</span>
	<span class="token function">OS_TaskInitTCB</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 修改任务的状态为删除态,即处于休眠 */</span>
	p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> <span class="token punctuation">(</span>OS_STATE<span class="token punctuation">)</span>OS_TASK_STATE_DEL<span class="token punctuation">;</span>
    
	<span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 任务切换,寻找最高优先级的任务 */</span>
	<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span><span class="token comment">/* OS_CFG_TASK_DEL_EN &gt; 0u */</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><ul><li>任务删除是一个可选功能,由<code>OS_CFG_TASK_DEL_EN</code>控制(os_cfg.h).</li> <li>空闲任务不能被删除.系统必须至少有一个任务在运行,当没有其他用户任务运行的时候,系统就会运行空闲任务.</li></ul></li></ul> <h1 id="任务管理"><a href="#任务管理" class="header-anchor">#</a> 任务管理</h1> <h2 id="任务管理的基本概念"><a href="#任务管理的基本概念" class="header-anchor">#</a> 任务管理的基本概念</h2> <ul><li>从系统的角度看,任务是竞争系统资源的最小运行单元.μC/OS是一个支持多任务的操作系统.在μC/OS中,任务可以使用或等待CPU,使用内存空间等系统资源,并独立于其他任务运行,任何数量的任务可以共享同一个优先级,处于就绪态的多个相同优先级任务将会以时间片切换的方式共享处理器.</li> <li>μC/OS的任务可认为是一系列独立任务的集合,每个任务在自己的环境中运行.在任何时刻,只有一个任务得到运行,μC/OS调度器决定运行哪个任务.调度器会不断的启动,轮换每一个任务,宏观看上去所有的任务都在同时在执行.任务不需要对调度器的活动有所了解,在任务切入切出时保存上下文环境(寄存器值,栈内容)是调度器主要的职责.为了实现这点,μC/OS中每个任务都需要有自己的栈空间.当任务切出时,它的执行环境会被保存在该任务的栈空间中,这样当任务再次运行时,就能从栈中正确的恢复上次的运行环境,任务越多,需要的栈空间就越大,而一个系统能运行多少个任务,取决于系统的可用的SRAM.</li> <li>μC/OS的可以给用户提供多个任务单独享有独立的栈空间.系统可用决定任务的状态,决定任务是否可以运行,同时还能运用内核的IPC通信资源,实现了任务之间的通信,帮助用户管理业务程序流程.这样用户可以将更多的精力投入到业务功能的实现中.</li> <li>μC/OS中的任务是抢占式调度机制,高优先级的任务可打断低优先级任务,低优先级任务必须在高优先级任务阻塞或结束后才能得到调度.同时μC/OS也支持时间片轮转调度方式,只不过时间片的调度是不允许抢占任务的CPU使用权.</li> <li>任务通常会运行在一个死循环中,也不会退出,如果一个任务不再需要,可以调用μC/OS中的任务删除API函数接口显式地将其删除.</li></ul> <h2 id="任务调度器的基本概念"><a href="#任务调度器的基本概念" class="header-anchor">#</a> 任务调度器的基本概念</h2> <ul><li>μC/OS中提供的任务调度器是基于优先级的全抢占式调度:在系统中除了中断处理函数,调度器上锁部分的代码和禁止中断的代码是不可抢占的之外,系统的其他部分都是可以抢占的.系统理论上可以支持无数个优先级 (0-N,优先级数值越大的任务优先级越低,<code>(OS_CFG_PRIO_MAX - 1u)</code>为最低优先级,分配给空闲任务使用,一般不建议用户来使用这个优先级.一般系统默认的最大可用优先级数目为 32.在一些资源比较紧张的系统中,用户可以根据实际情况选择只支持8个或自定义个数优先级的系统配置.在系统中,当有比当前任务优先级更高的任务就绪时,当前任务将立刻被切出,高优先级任务抢占处理器运行.</li> <li>一个操作系统如果只是具备了高优先级任务能够&quot;立即&quot;获得处理器并得到执行的特点,那么它仍然不算是实时操作系统.因为这个查找最高优先级任务的过程决定了调度时间是否具有确定性,例如一个包含n个就绪任务的系统中,如果仅仅从头找到尾,那么这个时间将直接和n相关,而下一个就绪任务抉择时间的长短将会极大的影响系统的实时性.</li> <li>μC/OS内核中采用两种方法寻找最高优先级的任务,第一种是通用的方法,因为μC/OS防止CPU平台不支持前导零指令,就采用C语言模仿前导零指令的效果实现了快速查找到最高优先级任务的方法.而第二种方法则是特殊方法,利用硬件计算前导零指令CLZ,这样子一次就能知道哪一个优先级任务能够运行,这种调度算法比普通方法更快捷,但受限于平台(在STM32中我们就使用这种方法).</li> <li>μC/OS内核中也允许创建相同优先级的任务.相同优先级的任务采用时间片轮转方式进行调度(也就是通常说的分时调度器),时间片轮转调度仅在当前系统中无更高优先级就绪任务存在的情况下才有效.为了保证系统的实时性,系统尽最大可能地保证高优先级的任务得以运行.任务调度的原则是一旦任务状态发生了改变,并且当前运行的任务优先级小于优先级队列组中任务最高优先级时,立刻进行任务切换(除非当前系统处于中断处理程序中或禁止任务切换的状态).</li></ul> <h2 id="任务状态迁移"><a href="#任务状态迁移" class="header-anchor">#</a> 任务状态迁移</h2> <p><img src="https://778b-1317013106.cos.ap-nanjing.myqcloud.com/img/%E7%8A%B6%E6%80%81%E8%BF%81%E7%A7%BB%E5%9B%BE.png" alt="状态迁移图"></p> <ul><li><p>任务状态迁移图①:创建任务→就绪态(Ready):任务创建完成后进入就绪态,表明任务已准备就绪,随时可以运行,只等待调度器进行调度.</p></li> <li><p>任务状态迁移图②:就绪态→运行态(Running):发生任务切换时,就绪列表中最高优先级的任务被执行,从而进入运行态.</p></li> <li><p>任务状态迁移图③:运行态→就绪态:有更高优先级任务创建或者恢复后,会发生任务调度,此刻就绪列表中最高优先级任务变为运行态,那么原先运行的任务由运行态变为就绪态,依然在就绪列表中,等待最高优先级的任务运行完毕继续运行原来的任务(此处可以看作CPU使用权被更高优先级的任务抢占了).</p></li> <li><p>任务状态迁移图④:运行态→阻塞态(或者称为挂起态Suspended):正在运行的任务发生阻塞(挂起,延时,读信号量等待)时,该任务会从就绪列表中删除,任务状态由运行态变成阻塞态,然后发生任务切换,运行就绪列表中当前最高优先级任务.</p></li> <li><p>任务状态迁移图⑤:阻塞态→就绪态:阻塞的任务被恢复后(任务恢复,延时时间超时,读信号量超时或读到信号量等),此时被恢复的任务会被加入就绪列表,从而由阻塞态变成就绪态;如果此时被恢复任务的优先级高于正在运行任务的优先级,则会发生任务切换,将该任务将再次转换任务状态,由就绪态变成运行态.</p></li> <li><p>任务状态迁移图⑥⑦⑧:就绪态,阻塞态,运行态→删除态(Delete):任务可以通过调用<code>OSTaskDel()</code>API函数都可以将处于任何状态的任务删除,被删除后的任务将不能再次使用,关于任务的资源都会被系统回收.</p></li> <li><p>任务状态迁移图⑨:删除态→就绪态:这就是创建任务的过程,一个任务将会从无到有,创建成功的任务可以参与系统的调度.</p></li></ul> <p>ps:此处的任务状态只是大致的任务状态而并非μC/OS的所有任务状态.</p> <h2 id="μc-os任务状态"><a href="#μc-os任务状态" class="header-anchor">#</a> μC/OS任务状态</h2> <p>μC/OS系统中的每一任务都有多种运行状态.系统初始化完成后,创建的任务就可以在系统中竞争一定的资源,由内核进行调度.</p> <p>μC/OS的任务状态通常分为以下几种:</p> <ul><li>就绪<code>OS_TASK_STATE_RDY</code>:该任务在就绪列表中,就绪的任务已经具备执行的能力,只等待调度器进行调度,新创建的任务会初始化为就绪态.</li> <li>延时<code>OS_TASK_STATE_DLY</code>:该任务处于延时调度状态.</li> <li>等待<code>OS_TASK_STATE_PEND</code>:任务调用<code>OSQPend()</code>,<code>OSSemPend()</code>这类等待函数,系统就会设置一个超时时间让该任务处于等待状态,如果超时时间设置为0,任务的状态,无限期等下去,直到事件发生.如果超时时间为N(N&gt;0),在N个时间内任务等待的事件或信号都没发生,就退出等待状态转为就绪状态.</li> <li>运行<code>Running</code>:该状态表明任务正在执行,此时它占用处理器,ΜC/OS调度器选择运行的永远是处于最高优先级的就绪态任务,当任务被运行的一刻,它的任务状态就变成了运行态,其实运行态的任务也是处于就绪列表中的.</li> <li>挂起<code>OS_TASK_STATE_SUSPENDED</code>:任务通过调用<code>OSTaskSuspend()</code>函数能够挂起自己或其他任务,调用<code>OSTaskResume()</code>是使被挂起的任务回复运行的唯一的方法.挂起一任务意味着该任务再被恢复运行以前不能够取得CPU的使用权,类似强行暂停一个任务.</li> <li>延时+挂起<code>OS_TASK_STATE_DLY_SUSPENDED</code>:任务先产生一个延时,延时没结束的时候被其他任务挂起,挂起的效果叠加,当且仅当延时结束并且挂起被恢复了,该任务才能够再次运行.</li> <li>等待+挂起<code>OS_TASK_STATE_PEND_SUSPENDED</code>:任务先等待一个事件或信号的发生(无限期等待),还没等待到就被其他任务挂起,挂起的效果叠加,当且仅当任务等待到事件或信号并且挂起被恢复了,该任务才能够再次运行.</li> <li>超时等待+挂起<code>OS_TASK_STATE_PEND_TIMEOUT_SUSPENDED</code>:任务在指定时间内等待事件或信号的产生,但是任务已经被其他任务挂起.</li> <li>删除<code>OS_TASK_STATE_DEL</code>:任务被删除后的状态,任务被删除后将不再运行,除非重新创建任务.</li></ul> <h2 id="常用任务函数"><a href="#常用任务函数" class="header-anchor">#</a> 常用任务函数</h2> <table><thead><tr><th>函数名称</th> <th>函数作用</th></tr></thead> <tbody><tr><td>OS_TaskSuspend()</td> <td>任务挂起</td></tr> <tr><td>OSTaskResume()</td> <td>任务恢复</td></tr> <tr><td>OSTaskDel()</td> <td>任务删除</td></tr> <tr><td>OSTimeDly()</td> <td>任务延时</td></tr> <tr><td>OSTimeDlyHMSM()</td> <td>任务延时</td></tr></tbody></table> <ul><li><p>OS_TaskSuspend()</p> <p>被挂起的任务绝不会得到CPU的使用权,不管该任务具有什么优先级.任务可以通过调用 <code>vTaskSuspend()</code>函数都可以将处于任何状态的任务挂起,被挂起的任务得不到CPU的使用权,也不会参与调度,它相对于调度器而言是不可见的,除非它从挂起态中解除.任务挂起是我们经常使用的一个函数,想要使用的就必须将宏定义<code>OS_CFG_TASK_SUSPEND_EN</code>启用,这样在编译的时候才会包含<code>OS_TaskSuspend()</code>函数.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_SUSPEND_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了函数 OSTaskSuspend()</span></span>
<span class="token keyword">void</span> <span class="token function">OS_TaskSuspend</span><span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使用到临界段(在关/开中断时)时必须用到该宏,该宏声明和</span>
	<span class="token comment">//定义一个局部变量,用于保存关中断前的 CPU 状态寄存器</span>
	<span class="token comment">//SR(临界段关中断只需保存SR),开中断时将该值还原.</span>
	<span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果 p_tcb 为空</span>
		p_tcb <span class="token operator">=</span> OSTCBCurPtr<span class="token punctuation">;</span> <span class="token comment">//挂起自身</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> OSTCBCurPtr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果是挂起自身</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>OSSchedLockNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果调度器被锁</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_SCHED_LOCKED<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;调度器被锁&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;无错误&quot;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>TaskState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//根据 p_tcb 的任务状态分类处理</span>
		<span class="token keyword">case</span> OS_TASK_STATE_RDY<span class="token operator">:</span><span class="token comment">//如果是就绪状态</span>
			<span class="token function">OS_CRITICAL_ENTER_CPU_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//锁调度器,重开中断</span>
			p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_SUSPENDED<span class="token punctuation">;</span> <span class="token comment">//任务状态改为&quot;挂起状态&quot;</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//挂起前套数为 1</span>
			<span class="token function">OS_RdyListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将任务从就绪列表移除</span>
			<span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开调度器,不进行调度</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		
        <span class="token keyword">case</span> OS_TASK_STATE_DLY<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token comment">//如果是延时状态将改为&quot;延时中被挂起&quot;</span>
			p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_DLY_SUSPENDED<span class="token punctuation">;</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//挂起前套数为 1</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND<span class="token operator">:</span><span class="token comment">//如果是无期限等待状态将改为&quot;无期限等待中被挂起&quot;</span>
			p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_PEND_SUSPENDED<span class="token punctuation">;</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//挂起前套数为 1</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_TIMEOUT<span class="token operator">:</span><span class="token comment">//如果是有期限等待将改为&quot;有期限等待中被挂起&quot;</span>
			p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_PEND_TIMEOUT_SUSPENDED<span class="token punctuation">;</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//挂起前套数为 1</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_SUSPENDED<span class="token operator">:</span><span class="token comment">//如果状态中有挂起状态</span>
		<span class="token keyword">case</span> OS_TASK_STATE_DLY_SUSPENDED<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_SUSPENDED<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_TIMEOUT_SUSPENDED<span class="token operator">:</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//挂起嵌套数加 1</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">default</span><span class="token operator">:</span><span class="token comment">//如果任务状态超出预期</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_STATE_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;状态非法&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
		
	<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调度任务</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>ps:任务可以调用<code>OS_TaskSuspend()</code>这个函数来挂起任务自身,但是在挂起自身的时候会进行一次任务上下文切换,需要挂起自身就将任务控制块指针设置为NULL或0传递进来即可.无论任务是什么状态都可以被挂起,只要调用了<code>OS_TaskSuspend()</code>这个函数就会挂起成功,不论是挂起其他任务还是挂起任务自身.任务的挂起与恢复函数在很多时候都是很有用的,比如我们想暂停某个任务运行一段时间,但是我们又需要在其恢复的时候继续工作,那么删除任务是不可能的,因为删除了任务的话,任务的所有的信息都是不可能恢复的了,删除是完完全全删除了,里面的资源都被系统释放掉,但是挂起任务就不会这样子,调用挂起任务函数,仅仅是将任务进入挂起态,其内部的资源都会保留下来,同时也不会参与系统中任务的调度,当调用恢复函数的时候,整个任务立即从挂起态进入就绪态,并且参与任务的调度,如果该任务的优先级是当前就绪态优先级最高的任务,那么立即会按照挂起前的任务状态继续执行该任务,从而达到我们需要的效果,注意,是继续执行,也就是说,挂起任务之前是什么状态,都会被系统保留下来,在恢复的瞬间,继续执行.这个任务函数的使用方法是很简单的,只需把任务句柄传递进来即可,<code>OS_TaskSuspend()</code>会根据任务句柄的信息将对应的任务挂起,任务的设计要点.</p></li> <li><p>OSTaskResume()函数</p> <p>任务恢复就是让挂起的任务重新进入就绪状态,恢复的任务会保留挂起前的状态信息,在恢复的时候根据挂起时的状态继续运行.如果被恢复任务在所有就绪态任务中,处于最高优先级列表的第一位,那么系统将进行任务上下文的切换.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_SUSPEND_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了函数 OSTaskResume()</span></span>
<span class="token keyword">void</span> <span class="token function">OSTaskResume</span><span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用到临界段(在关/开中断时)时必须用到该宏,该宏声明和</span>
	<span class="token comment">//定义一个局部变量,用于保存关中断前的 CPU 状态寄存器</span>
	<span class="token comment">// SR(临界段关中断只需保存 SR),开中断时将该值还原.</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">OS_SAFETY_CRITICAL</span><span class="token comment">//如果启用了安全检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_err <span class="token operator">==</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果 p_err 为空</span>
		<span class="token function">OS_SAFETY_CRITICAL_EXCEPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行安全检测异常函数</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">//如果禁用了中断延迟发布和中断中非法调用检测</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>OS_CFG_ISR_POST_DEFERRED_EN <span class="token operator">==</span> <span class="token number">0u</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>OS_CFG_CALLED_FROM_ISR_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span><span class="token punctuation">)</span></span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果在中断中调用该函数</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TASK_RESUME_ISR<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;在中断中恢复任务&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ARG_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了参数检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> OSTCBCurPtr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果被恢复任务为空或是自身</span>
		<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TASK_RESUME_SELF<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;恢复自身&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ISR_POST_DEFERRED_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了中断延迟发布</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果该函数在中断中被调用</span>
		<span class="token function">OS_IntQPost</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OBJ_TYPE<span class="token punctuation">)</span>OS_OBJ_TYPE_TASK_RESUME<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">void</span>      <span class="token operator">*</span><span class="token punctuation">)</span>p_tcb<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">void</span>      <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_MSG_SIZE<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_FLAGS   <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_OPT     <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>CPU_TS 	<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>OS_ERR    <span class="token operator">*</span><span class="token punctuation">)</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把恢复任务命令发布到中断消息队列</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">/* 如果禁用了中断延迟发布或不是在中断中调用该函数,直接调用`OS_TaskResume()`函数恢复任务*/</span>
	<span class="token function">OS_TaskResume</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">,</span> p_err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//直接将任务 p_tcb 恢复</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p><code>OS_TaskResume()</code>函数</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_SUSPEND_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了函数OSTaskResume()</span></span>
<span class="token keyword">void</span> <span class="token function">OS_TaskResume</span><span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用到临界段(在关/开中断时)时必须用到该宏,该宏声明和</span>
	<span class="token comment">//定义一个局部变量,用于保存关中断前的 CPU 状态寄存器</span>
	<span class="token comment">// SR(临界段关中断只需保存 SR),开中断时将该值还原.</span>
	<span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
	<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;无错误&quot;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>TaskState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//根据 p_tcb 的任务状态分类处理</span>
		<span class="token keyword">case</span> OS_TASK_STATE_RDY<span class="token operator">:</span> <span class="token comment">//如果状态中没有挂起状态</span>
		<span class="token keyword">case</span> OS_TASK_STATE_DLY<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_TIMEOUT<span class="token operator">:</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TASK_NOT_SUSPENDED<span class="token punctuation">;</span><span class="token comment">//错误类型为&quot;任务未被挂起&quot;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_SUSPENDED<span class="token operator">:</span><span class="token comment">//如果是&quot;挂起状态&quot;</span>
			<span class="token function">OS_CRITICAL_ENTER_CPU_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//锁调度器,重开中断</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//任务的挂起嵌套数减 1</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>SuspendCtr <span class="token operator">==</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果挂起前套数为 0</span>
				p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_RDY<span class="token punctuation">;</span> <span class="token comment">//修改状态为&quot;就绪状态&quot;</span>
				<span class="token function">OS_TaskRdy</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//把 p_tcb 插入就绪列表</span>
			<span class="token punctuation">}</span>
			<span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开调度器,不调度任务</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_DLY_SUSPENDED<span class="token operator">:</span><span class="token comment">//如果是&quot;延时中被挂起&quot;</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">//任务的挂起嵌套数减 1</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>SuspendCtr <span class="token operator">==</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果挂起前套数为 0</span>
				p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_DLY<span class="token punctuation">;</span> <span class="token comment">//修改状态为&quot;延时状态&quot;</span>
			<span class="token punctuation">}</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_SUSPENDED<span class="token operator">:</span><span class="token comment">//如果是&quot;无期限等待中被挂起&quot;</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">//任务的挂起嵌套数减 1</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>SuspendCtr <span class="token operator">==</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果挂起前套数为 0</span>
				p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_PEND<span class="token punctuation">;</span> <span class="token comment">//修改状态为&quot;无期限等待状态&quot;</span>
			<span class="token punctuation">}</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_TIMEOUT_SUSPENDED<span class="token operator">:</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token comment">//如果是&quot;有期限等待中被挂起&quot;</span>
			p_tcb<span class="token operator">-&gt;</span>SuspendCtr<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">//任务的挂起嵌套数减 1</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>SuspendCtr <span class="token operator">==</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果挂起前套数为0</span>
				p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_PEND_TIMEOUT<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果 p_tcb 任务状态超出预期</span>
			<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_STATE_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;状态非法&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//跳出</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调度任务</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>ps:<code>OSTaskResume()</code>函数用于恢复挂起的任务.任务在挂起时候调用过多少次的<code>OS_TaskSuspend()</code> 函数,那么就需要调用多少次<code>OSTaskResume()</code>函数才能将任务恢复运行.</p></li> <li><p>OSTaskDel()函数</p> <p>当一个任务删除另外一个任务时,形参为要删除任务创建时返回的任务句柄,如果是删除自身,则形参为NULL.要想使用该函数必须在os_cfg.h中把<code>OS_CFG_TASK_DEL_EN</code>宏定义配置为1,删除的任务将从所有就绪,阻塞,挂起和事件列表中删除.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_DEL_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了函数 OSTaskDel()</span></span>
<span class="token keyword">void</span> <span class="token function">OSTaskDel</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用到临界段(在关/开中断时)时必须用到该宏,该宏声明和</span>
	<span class="token comment">//定义一个局部变量,用于保存关中断前的 CPU 状态寄存器</span>
	<span class="token comment">// SR(临界段关中断只需保存 SR),开中断时将该值还原.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">OS_SAFETY_CRITICAL</span><span class="token comment">//如果启用(默认禁用)了安全检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_err <span class="token operator">==</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果 p_err 为空</span>
		<span class="token function">OS_SAFETY_CRITICAL_EXCEPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行安全检测异常函数</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_CALLED_FROM_ISR_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span><span class="token comment">//如果启用了中断中非法调用检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果该函数在中断中被调用</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TASK_DEL_ISR<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;在中断中删除任务&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> <span class="token operator">&amp;</span>OSIdleTaskTCB<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果目标任务是空闲任务</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TASK_DEL_IDLE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;删除空闲任务&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ISR_POST_DEFERRED_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了中断延迟发布</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> <span class="token operator">&amp;</span>OSIntQTaskTCB<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果目标任务是中断延迟提交任务</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TASK_DEL_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;非法删除任务&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb <span class="token operator">==</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果 p_tcb 为空</span>
		<span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关中断</span>
		p_tcb <span class="token operator">=</span> OSTCBCurPtr<span class="token punctuation">;</span> <span class="token comment">//目标任务设为自身</span>
		<span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开中断</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">OS_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//进入临界段</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>TaskState<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//根据目标任务的任务状态分类处理</span>
		<span class="token keyword">case</span> OS_TASK_STATE_RDY<span class="token operator">:</span> <span class="token comment">//如果是就绪状态</span>
			<span class="token function">OS_RdyListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将任务从就绪列表移除</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
        <span class="token keyword">case</span> OS_TASK_STATE_SUSPENDED<span class="token operator">:</span> <span class="token comment">//如果是挂起状态</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//直接跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_DLY<span class="token operator">:</span> <span class="token comment">//如果包含延时状态</span>
		<span class="token keyword">case</span> OS_TASK_STATE_DLY_SUSPENDED<span class="token operator">:</span>
			<span class="token function">OS_TickListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将任务从节拍列表移除</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND<span class="token operator">:</span> <span class="token comment">//如果包含等待状态</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_SUSPENDED<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_TIMEOUT<span class="token operator">:</span>
		<span class="token keyword">case</span> OS_TASK_STATE_PEND_TIMEOUT_SUSPENDED<span class="token operator">:</span>
			<span class="token function">OS_TickListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将任务从节拍列表移除</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>PendOn<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//根据任务的等待对象分类处理</span>
				<span class="token keyword">case</span> OS_TASK_PEND_ON_NOTHING<span class="token operator">:</span> <span class="token comment">//如果没在等待内核对象</span>
				<span class="token keyword">case</span> OS_TASK_PEND_ON_TASK_Q<span class="token operator">:</span> <span class="token comment">//如果等待的是任务消息队列</span>
				<span class="token keyword">case</span> OS_TASK_PEND_ON_TASK_SEM<span class="token operator">:</span><span class="token comment">//如果等待的是任务信号量</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//直接跳出</span>
				<span class="token keyword">case</span> OS_TASK_PEND_ON_FLAG<span class="token operator">:</span> <span class="token comment">//如果等待的是事件</span>
				<span class="token keyword">case</span> OS_TASK_PEND_ON_MULTI<span class="token operator">:</span> <span class="token comment">//如果等待多个内核对象</span>
				<span class="token keyword">case</span> OS_TASK_PEND_ON_MUTEX<span class="token operator">:</span> <span class="token comment">//如果等待的是互斥量</span>
				<span class="token keyword">case</span> OS_TASK_PEND_ON_Q<span class="token operator">:</span> <span class="token comment">//如果等待的是消息队列</span>
				<span class="token keyword">case</span> OS_TASK_PEND_ON_SEM<span class="token operator">:</span> <span class="token comment">//如果等待的是信号量</span>
					<span class="token function">OS_PendListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将任务从等待列表移除</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
				<span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果等待对象超出预期</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//直接跳出</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出</span>
		<span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果目标任务状态超出预期</span>
			<span class="token function">OS_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退出临界段</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_STATE_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;状态非法&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,停止执行</span>
	<span class="token punctuation">}</span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TASK_Q_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了任务消息队列</span></span>
	<span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">OS_MsgQFreeAll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p_tcb<span class="token operator">-&gt;</span>MsgQ<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放任务的所有任务消息</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token function">OSTaskDelHook</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用用户自定义的钩子函数</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>OS_CFG_TLS_TBL_SIZE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>OS_CFG_TLS_TBL_SIZE <span class="token operator">&gt;</span> <span class="token number">0u</span><span class="token punctuation">)</span></span></span>
	<span class="token function">OS_TLS_TaskDel</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Call TLSk ␣ ,→ */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_DBG_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用了调试代码和变量</span></span>
	<span class="token function">OS_TaskDbgListRemove</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将任务从任务调试双向列表移除</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	OSTaskQty<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">//任务数目减 1</span>
	
	<span class="token function">OS_TaskInitTCB</span><span class="token punctuation">(</span>p_tcb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化任务控制块</span>
	p_tcb<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> <span class="token punctuation">(</span>OS_STATE<span class="token punctuation">)</span>OS_TASK_STATE_DEL<span class="token punctuation">;</span><span class="token comment">//标定任务已被删除</span>
	
	<span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退出临界段(无调度)</span>
	
	<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;无错误&quot;</span>
	
	<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调度任务</span>
<span class="token punctuation">}</span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><p>ps:删除任务是说任务将返回并处以删除(休眠)状态,任务的代码不再被μC/OS调用,删除任务不是删除代码,删除任务和挂起任务有些相似,其实有着本质的区别,根本来说,最大的不同就是删除任务队任务控制块的操作,我们知道在任务创建的时候,需要给每个任务分配一个任务控制块,这个任务控制块存储有关这个任务重要的信息,对任务间有至关重要的作用,挂起任务根本不会动任务控制块,但删除任务就会把任务控制块进行初始化,这样子关于任务的任何信息都被抹去.注意了,删除任务并不会释放任务的栈空间.</p></li> <li><p><code>OSTimeDly()</code>函数</p> <p><code>OSTimeDly()</code>函数在任务设计中用的非常之多,每个任务都必须是死循环,并且是必须要有阻塞的情况,否则低优先级的任务就无法被运行了,<code>OSTimeDly()</code>函数常用于停止当前任务进行的运行,延时一段时间后再运行.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">OSTimeDly</span> <span class="token punctuation">(</span>OS_TICK dly<span class="token punctuation">,</span>OS_OPT opt<span class="token punctuation">,</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//使用到临界段(在关/开中断时)时必须用到该宏,该宏声明和定义一个局部变</span>
	<span class="token comment">//量,用于保存关中断前的 CPU 状态寄存器 SR(临界段关中断只需保存 SR)</span>
    <span class="token comment">//开中断时将该值还原.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression"><span class="token function">OS_SAFETY_CRITICAL</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span></span><span class="token comment">//如果启用(默认禁用)了安全检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_err <span class="token operator">==</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果错误类型实参为空</span>
		<span class="token function">OS_SAFETY_CRITICAL_EXCEPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行安全检测异常函数</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_CALLED_FROM_ISR_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用(默认启用)了中断中非法调用检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果该延时函数是在中断中被调用</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_DLY_ISR<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;在中断函数中延时&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">/* 当调度器被锁时任务不能延时 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSSchedLockNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果调度器被锁</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_SCHED_LOCKED<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;调度器被锁&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//根据延时选项参数 opt 分类操作</span>
		<span class="token keyword">case</span> OS_OPT_TIME_DLY<span class="token operator">:</span> <span class="token comment">//如果选择相对时间(从现在起延时多长时间)</span>
		<span class="token keyword">case</span> OS_OPT_TIME_TIMEOUT<span class="token operator">:</span> <span class="token comment">//如果选择超时(实际同上)</span>
		<span class="token keyword">case</span> OS_OPT_TIME_PERIODIC<span class="token operator">:</span> <span class="token comment">//如果选择周期性延时</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>dly <span class="token operator">==</span> <span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果参数 dly 为 0(0 意味不延时)</span>
				<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_ZERO_DLY<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;0 延时&quot;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> OS_OPT_TIME_MATCH<span class="token operator">:</span>
			<span class="token comment">//如果选择绝对时间(匹配系统开始运行(OSStart())后的时钟节拍数)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span><span class="token comment">//如果选项超出范围</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_OPT_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;选项非法&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">OS_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//进入临界段</span>
	OSTCBCurPtr<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_DLY<span class="token punctuation">;</span> <span class="token comment">//修改当前任务的任务状态为延时状态</span>
	<span class="token function">OS_TickListInsert</span><span class="token punctuation">(</span>OSTCBCurPtr<span class="token punctuation">,</span>dly<span class="token punctuation">,</span>opt<span class="token punctuation">,</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将当前任务插入节拍列表</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p_err <span class="token operator">!=</span> OS_ERR_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果当前任务插入节拍列表时出现错误</span>
		<span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退出临界段(无调度)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
	<span class="token function">OS_RdyListRemove</span><span class="token punctuation">(</span>OSTCBCurPtr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从就绪列表移除当前任务</span>
	<span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退出临界段(无调度)</span>
	<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//任务切换</span>
	<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;无错误&quot;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>任务延时OPT</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_OPT_TIME_DLY</span> <span class="token expression">DEF_BIT_NONE</span></span>
<span class="token number">2</span> #define <span class="token function">OS_OPT_TIME_TIMEOUT</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span>DEF_BIT_01<span class="token punctuation">)</span>
<span class="token number">3</span> #define <span class="token function">OS_OPT_TIME_MATCH</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span>DEF_BIT_02<span class="token punctuation">)</span>
<span class="token number">4</span> #define <span class="token function">OS_OPT_TIME_PERIODIC</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span>DEF_BIT_03<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><code>OS_OPT_TIME_DLY</code>:dly为相对时间,就是从现在起延时多长时间,到时钟节拍总计数 <code>OSTickCtr = OSTickCtr</code> 当前+dly时延时结束.</li> <li><code>OS_OPT_TIME_TIMEOUT</code>:跟<code>OS_OPT_TIME_DLY</code>的作用情况一样.</li> <li><code>OS_OPT_TIME_MATCH</code>:dly为绝对时间,就是从系统开始运行(调用<code>OSStart()</code>)时到节拍总计数<code>OSTickCtr = dly</code>时延时结束.</li> <li><code>OS_OPT_TIME_PERIODIC</code>:周期性延时,跟<code>OS_OPT_TIME_DLY</code>的作用差不多,如果是长时间延时,该选项更精准一些.</li></ul> <p><code>OS_TickListInsert()</code>函数</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">OS_TickListInsert</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span>OS_TICK time<span class="token punctuation">,</span>OS_OPT opt<span class="token punctuation">,</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
    OS_TICK tick_delta<span class="token punctuation">;</span>
	OS_TICK tick_next<span class="token punctuation">;</span>
	OS_TICK_SPOKE <span class="token operator">*</span>p_spoke<span class="token punctuation">;</span>
	OS_TCB <span class="token operator">*</span>p_tcb0<span class="token punctuation">;</span>
	OS_TCB <span class="token operator">*</span>p_tcb1<span class="token punctuation">;</span>
	OS_TICK_SPOKE_IX spoke<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>opt <span class="token operator">==</span> OS_OPT_TIME_MATCH<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//如果 time 是个绝对时间</span>
		tick_delta <span class="token operator">=</span> time <span class="token operator">-</span> OSTickCtr <span class="token operator">-</span> <span class="token number">1u</span><span class="token punctuation">;</span> <span class="token comment">//计算离到期还有多长时间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tick_delta <span class="token operator">&gt;</span> OS_TICK_TH_RDY<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//如果延时时间超过了门限</span>
            p_tcb<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">;</span> <span class="token comment">//将任务的时钟节拍的匹配变量置0</span>
            p_tcb<span class="token operator">-&gt;</span>TickRemain <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">;</span> <span class="token comment">//将任务的延时还需时钟节拍数置0</span>
            p_tcb<span class="token operator">-&gt;</span>TickSpokePtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TICK_SPOKE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//该任务不插入节拍列表</span>
            <span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_ZERO_DLY<span class="token punctuation">;</span> <span class="token comment">//错误类型相当于&quot;0 延时&quot;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不将任务插入节拍列表</span>
        <span class="token punctuation">}</span>
		p_tcb<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">=</span> time<span class="token punctuation">;</span> <span class="token comment">//任务等待的匹配点为 OSTickCtr = time</span>
		p_tcb<span class="token operator">-&gt;</span>TickRemain <span class="token operator">=</span> tick_delta <span class="token operator">+</span> <span class="token number">1u</span><span class="token punctuation">;</span> <span class="token comment">//计算任务离到期还有多长时间</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//如果 time &gt; 0</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>opt <span class="token operator">==</span> OS_OPT_TIME_PERIODIC<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果 time 是周期性时间</span>
			tick_next <span class="token operator">=</span> p_tcb<span class="token operator">-&gt;</span>TickCtrPrev <span class="token operator">+</span> time<span class="token punctuation">;</span>
			<span class="token comment">//计算任务接下来要匹配的时钟节拍总计数</span>
			tick_delta <span class="token operator">=</span> tick_next <span class="token operator">-</span> OSTickCtr <span class="token operator">-</span> <span class="token number">1u</span><span class="token punctuation">;</span> <span class="token comment">//计算任务离匹配还有个多长时间</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>tick_delta <span class="token operator">&lt;</span> time<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//如果 p_tcb-&gt;TickCtrPrev&lt;OSTickCtr+1</span>
				p_tcb<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">=</span> tick_next<span class="token punctuation">;</span> <span class="token comment">//将 p_tcb-&gt;TickCtrPrev +time 设为时钟节拍匹配点</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果 p_tcb-&gt;TickCtrPrev &gt;= OSTickCtr + 1</span>
				p_tcb<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">=</span> OSTickCtr <span class="token operator">+</span> time<span class="token punctuation">;</span> <span class="token comment">//将 OSTickCtr +time 设为时钟节拍匹配点</span>
			<span class="token punctuation">}</span>
			p_tcb<span class="token operator">-&gt;</span>TickRemain <span class="token operator">=</span> p_tcb<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">-</span> OSTickCtr<span class="token punctuation">;</span> <span class="token comment">//计算任务离到期还有多长时间</span>
			p_tcb<span class="token operator">-&gt;</span>TickCtrPrev <span class="token operator">=</span> p_tcb<span class="token operator">-&gt;</span>TickCtrMatch<span class="token punctuation">;</span> <span class="token comment">//保存当前匹配值为下一周期延时用</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果 time 是相对时间</span>
			p_tcb<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">=</span> OSTickCtr <span class="token operator">+</span> time<span class="token punctuation">;</span> <span class="token comment">//任务等待的匹配点为 ,OSTickCtr + time</span>
			p_tcb<span class="token operator">-&gt;</span>TickRemain <span class="token operator">=</span> time<span class="token punctuation">;</span> <span class="token comment">//计算任务离到期的时间就是 time</span>
		<span class="token punctuation">}</span>
	
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果 time = 0</span>
		p_tcb<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">;</span> <span class="token comment">//将任务的时钟节拍的匹配变量置0</span>
		p_tcb<span class="token operator">-&gt;</span>TickRemain <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">;</span> <span class="token comment">//将任务的延时还需时钟节拍数置 0</span>
		p_tcb<span class="token operator">-&gt;</span>TickSpokePtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TICK_SPOKE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//该任务不插入节拍列表</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_ZERO_DLY<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;0 延时&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不将任务插入节拍列表</span>
	<span class="token punctuation">}</span>
	
	spoke <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TICK_SPOKE_IX<span class="token punctuation">)</span><span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">%</span> OSCfg_TickWheelSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使用哈希算法(取余)来决定任务存于数组</span>
	p_spoke <span class="token operator">=</span> <span class="token operator">&amp;</span>OSCfg_TickWheel<span class="token punctuation">[</span>spoke<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">//OSCfg_TickWheel 的哪个元素(组织一个节拍列表),</span>
	<span class="token comment">//与更新节拍列表相对应,可方便查找到期任务.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_spoke<span class="token operator">-&gt;</span>NbrEntries <span class="token operator">==</span> <span class="token punctuation">(</span>OS_OBJ_QTY<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果当前节拍列表为空</span>
		p_tcb<span class="token operator">-&gt;</span>TickNextPtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token comment">//任务中指向节拍列表中下一个任务的指针置空</span>
		p_tcb<span class="token operator">-&gt;</span>TickPrevPtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token comment">//任务中指向节拍列表中前一个任务的指针置空</span>
		p_spoke<span class="token operator">-&gt;</span>FirstPtr <span class="token operator">=</span> p_tcb<span class="token punctuation">;</span>
		<span class="token comment">//当前任务被列为该节拍列表的第一个任务</span>
		p_spoke<span class="token operator">-&gt;</span>NbrEntries <span class="token operator">=</span> <span class="token punctuation">(</span>OS_OBJ_QTY<span class="token punctuation">)</span><span class="token number">1u</span><span class="token punctuation">;</span> <span class="token comment">//节拍列表中的元素数目为 1</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果当前节拍列表非空</span>
		p_tcb1 <span class="token operator">=</span> p_spoke<span class="token operator">-&gt;</span>FirstPtr<span class="token punctuation">;</span> <span class="token comment">//获取列表中的第一个任务</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>p_tcb1 <span class="token operator">!=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果该任务存在</span>
			p_tcb1<span class="token operator">-&gt;</span>TickRemain <span class="token operator">=</span> p_tcb1<span class="token operator">-&gt;</span>TickCtrMatch <span class="token operator">-</span> OSTickCtr<span class="token punctuation">;</span><span class="token comment">//计算该任务的剩余等待时间</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb<span class="token operator">-&gt;</span>TickRemain <span class="token operator">&gt;</span> p_tcb1<span class="token operator">-&gt;</span>TickRemain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">//如果当前任务的剩余等待时间大于该任务的</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb1<span class="token operator">-&gt;</span>TickNextPtr <span class="token operator">!=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果该任务不是列表的最后一个元素</span>
					p_tcb1 <span class="token operator">=</span> p_tcb1<span class="token operator">-&gt;</span>TickNextPtr<span class="token punctuation">;</span>
					<span class="token comment">//让当前任务继续与该任务的下一个任务作比较</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果该任务是列表的最后一个元素</span>
					p_tcb<span class="token operator">-&gt;</span>TickNextPtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//当前任务为列表的最后一个元素</span>
					p_tcb<span class="token operator">-&gt;</span>TickPrevPtr <span class="token operator">=</span> p_tcb1<span class="token punctuation">;</span> <span class="token comment">//该任务是当前任务的前一个元素</span>
					p_tcb1<span class="token operator">-&gt;</span>TickNextPtr <span class="token operator">=</span> p_tcb<span class="token punctuation">;</span> <span class="token comment">//当前任务是该任务的后一个元素</span>
					p_tcb1 <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//插入完成,退出 while␣ ,→循环</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果当前任务的剩余等待时间不大于该任务的</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>p_tcb1<span class="token operator">-&gt;</span>TickPrevPtr <span class="token operator">==</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果该任务是列表的第一个元素</span>
					p_tcb<span class="token operator">-&gt;</span>TickPrevPtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//当前任务就作为列表的第一个元素</span>
					p_tcb<span class="token operator">-&gt;</span>TickNextPtr <span class="token operator">=</span> p_tcb1<span class="token punctuation">;</span> <span class="token comment">//该任务是当前任务的后一个元素</span>
					p_tcb1<span class="token operator">-&gt;</span>TickPrevPtr <span class="token operator">=</span> p_tcb<span class="token punctuation">;</span> <span class="token comment">//当前任务是该任务的前一个元素</span>
					p_spoke<span class="token operator">-&gt;</span>FirstPtr <span class="token operator">=</span> p_tcb<span class="token punctuation">;</span> <span class="token comment">//当前任务是列表的第一个元素</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果该任务也不是是列表的第一个元素</span>
					p_tcb0 <span class="token operator">=</span> p_tcb1<span class="token operator">-&gt;</span>TickPrevPtr<span class="token punctuation">;</span> <span class="token comment">// p_tcb0 暂存该任务的前一个任务</span>
					p_tcb<span class="token operator">-&gt;</span>TickPrevPtr <span class="token operator">=</span> p_tcb0<span class="token punctuation">;</span>
					<span class="token comment">//该任务的前一个任务作为当前任务的前一个任务</span>
					p_tcb<span class="token operator">-&gt;</span>TickNextPtr <span class="token operator">=</span> p_tcb1<span class="token punctuation">;</span> <span class="token comment">//该任务作为当前任务的后一个任务</span>
					p_tcb0<span class="token operator">-&gt;</span>TickNextPtr <span class="token operator">=</span> p_tcb<span class="token punctuation">;</span> <span class="token comment">// p_tcb0 暂存的任务的下一个任务改为当前任务</span>
					p_tcb1<span class="token operator">-&gt;</span>TickPrevPtr <span class="token operator">=</span> p_tcb<span class="token punctuation">;</span> <span class="token comment">// 该任务的前一个任务也改为当前任务</span>
				<span class="token punctuation">}</span>
				p_tcb1 <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//插入完成,退出 while 循环</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	p_spoke<span class="token operator">-&gt;</span>NbrEntries<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//节拍列表中的元素数目加 1</span>
	<span class="token punctuation">}</span> <span class="token comment">//更新节拍列表的元素数目的最大记录</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_spoke<span class="token operator">-&gt;</span>NbrEntriesMax <span class="token operator">&lt;</span> p_spoke<span class="token operator">-&gt;</span>NbrEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		p_spoke<span class="token operator">-&gt;</span>NbrEntriesMax <span class="token operator">=</span> p_spoke<span class="token operator">-&gt;</span>NbrEntries<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	p_tcb<span class="token operator">-&gt;</span>TickSpokePtr <span class="token operator">=</span> p_spoke<span class="token punctuation">;</span> <span class="token comment">//记录当前任务存放于哪个节拍列表</span>
	<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span><span class="token comment">//错误类型为&quot;无错误&quot;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><p>任务的延时在实际中运用特别多,因为需要暂停一个任务,让任务放弃 CPU,延时结束后再继续运行该任务,如果任务中没有阻塞的话,比该任务优先级低的任务则无法得到 CPU 的使用权,就无法运行</p></li> <li><p>OSTimeDlyHMSM()函数</p> <p><code>OSTimeDlyHMSM()</code>函数与<code>OSTimeDly()</code>函数的功能类似,也是用于停止当前任务进行的运行,延时一段时间后再运行,但是<code>OSTimeDlyHMSM()</code>函数会更加直观,延时多少个小时,分钟,秒,毫秒.但是,用户若要使用<code>OSTimeDlyHMSM()</code>函数,必须将宏 <code>OS_CFG_TIME_DLY_HMSM_EN</code>(os_cfg.h)设为1</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TIME_DLY_HMSM_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用(默认启用)了OSTimeDlyHMSM()函数</span></span>
<span class="token number">2</span> <span class="token keyword">void</span> <span class="token function">OSTimeDlyHMSM</span> <span class="token punctuation">(</span>CPU_INT16U hours<span class="token punctuation">,</span><span class="token comment">//小时数</span>
                      CPU_INT16U minutes<span class="token punctuation">,</span><span class="token comment">//分钟数</span>
                      CPU_INT16U seconds<span class="token punctuation">,</span><span class="token comment">//秒数</span>
					  CPU_INT32U milli<span class="token punctuation">,</span><span class="token comment">//毫秒数</span>
                      OS_OPT opt<span class="token punctuation">,</span><span class="token comment">//选项</span>
                      OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ARG_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用(默认启用)了参数检测功能</span></span>
	CPU_BOOLEAN opt_invalid<span class="token punctuation">;</span> <span class="token comment">//声明变量用于参数检测</span>
	CPU_BOOLEAN opt_non_strict<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	OS_OPT opt_time<span class="token punctuation">;</span>
	OS_RATE_HZ tick_rate<span class="token punctuation">;</span>
	OS_TICK ticks<span class="token punctuation">;</span>
	<span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">OS_SAFETY_CRITICAL</span><span class="token comment">//如果启用(默认禁用)了安全检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p_err <span class="token operator">==</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果错误类型实参为空</span>
		<span class="token function">OS_SAFETY_CRITICAL_EXCEPTION</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//执行安全检测异常函数</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_CALLED_FROM_ISR_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span><span class="token comment">//如果启用(默认启用)了中断中非法调用检测</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果该延时函数是在中断中被调用</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_DLY_ISR<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;在中断函数中延时&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">/* 当调度器被锁时任务不能延时 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>OSSchedLockNestingCtr <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果调度器被锁</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_SCHED_LOCKED<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;调度器被锁&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
    
	opt_time <span class="token operator">=</span> opt <span class="token operator">&amp;</span> OS_OPT_TIME_MASK<span class="token punctuation">;</span> <span class="token comment">//检测除选项中与延时时间性质有关的位</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>opt_time<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//根据延时选项参数 opt 分类操作</span>
		<span class="token keyword">case</span> OS_OPT_TIME_DLY<span class="token operator">:</span> <span class="token comment">//如果选择相对时间(从现在起延时多长时间)</span>
		<span class="token keyword">case</span> OS_OPT_TIME_TIMEOUT<span class="token operator">:</span> <span class="token comment">//如果选择超时(实际同上)</span>
		<span class="token keyword">case</span> OS_OPT_TIME_PERIODIC<span class="token operator">:</span> <span class="token comment">//如果选择周期性延时</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>milli <span class="token operator">==</span> <span class="token punctuation">(</span>CPU_INT32U<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果毫秒数为 0</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>seconds <span class="token operator">==</span> <span class="token punctuation">(</span>CPU_INT16U<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果秒数为 0</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>minutes <span class="token operator">==</span> <span class="token punctuation">(</span>CPU_INT16U<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果分钟数为 0</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>hours <span class="token operator">==</span> <span class="token punctuation">(</span>CPU_INT16U<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果小时数为 0</span>
							<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_ZERO_DLY<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;0 延时&quot;</span>
							<span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//返回,不执行延时操作</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> OS_OPT_TIME_MATCH<span class="token operator">:</span>
			<span class="token comment">//如果选择绝对时间(把系统开始运行(OSStart() 时做为起点)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">//如果选项超出范围</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_OPT_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;选项非法&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_ARG_CHK_EN <span class="token operator">&gt;</span> <span class="token number">0u</span></span></span>
	<span class="token comment">//如果启用(默认启用)了参数检测功能</span>
	opt_invalid <span class="token operator">=</span> <span class="token function">DEF_BIT_IS_SET_ANY</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> <span class="token operator">~</span>OS_OPT_TIME_OPTS_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//检测除选项位以后其他位是否被置位</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>opt_invalid <span class="token operator">==</span> DEF_YES<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果除选项位以后其他位有被置位的</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_OPT_INVALID<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;选项非法&quot;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
	<span class="token punctuation">}</span>
    
	opt_non_strict <span class="token operator">=</span> <span class="token function">DEF_BIT_IS_SET</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> OS_OPT_TIME_HMSM_NON_STRICT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//检测有关时间参数取值范围的选项位</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>opt_non_strict <span class="token operator">!=</span> DEF_YES<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果选项选择了 OS_OPT_TIME_HMSM_STRICT</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>milli <span class="token operator">&gt;</span> <span class="token punctuation">(</span>CPU_INT32U<span class="token punctuation">)</span><span class="token number">999u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果毫秒数&gt;999</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_INVALID_MILLISECONDS<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;毫秒数不可用&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>seconds <span class="token operator">&gt;</span> <span class="token punctuation">(</span>CPU_INT16U<span class="token punctuation">)</span><span class="token number">59u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果秒数&gt;59</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_INVALID_SECONDS<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;秒数不可用&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>minutes <span class="token operator">&gt;</span> <span class="token punctuation">(</span>CPU_INT16U<span class="token punctuation">)</span><span class="token number">59u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果分钟数&gt;59</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_INVALID_MINUTES<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;分钟数不可用&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hours <span class="token operator">&gt;</span> <span class="token punctuation">(</span>CPU_INT16U<span class="token punctuation">)</span><span class="token number">99u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果小时数&gt;99</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_INVALID_HOURS<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;小时数不可用&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果选项选择了 OS_OPT_TIME_HMSM_NON_STRICT</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>minutes <span class="token operator">&gt;</span> <span class="token punctuation">(</span>CPU_INT16U<span class="token punctuation">)</span><span class="token number">9999u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果分钟数&gt;9999</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_INVALID_MINUTES<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;分钟数不可用&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hours <span class="token operator">&gt;</span> <span class="token punctuation">(</span>CPU_INT16U<span class="token punctuation">)</span><span class="token number">999u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//如果小时数&gt;999</span>
			<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_INVALID_HOURS<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;小时数不可用&quot;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token comment">/* 将延时时间转换成时钟节拍数 */</span>
	tick_rate <span class="token operator">=</span> OSCfg_TickRate_Hz<span class="token punctuation">;</span> <span class="token comment">//获取时钟节拍的频率</span>
	ticks <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span>hours <span class="token operator">*</span> <span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span><span class="token number">3600u</span> <span class="token operator">+</span> <span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span>minutes <span class="token operator">*</span>
	<span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span><span class="token number">60u</span> <span class="token operator">+</span> <span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span>seconds<span class="token punctuation">)</span> <span class="token operator">*</span> tick_rate <span class="token operator">+</span> <span class="token punctuation">(</span>tick_rate <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span>milli <span class="token operator">+</span> <span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span><span class="token number">500u</span> <span class="token operator">/</span> tick_rate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span><span class="token number">1000u</span><span class="token punctuation">;</span><span class="token comment">//将延时时间转换成时钟节拍数</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ticks <span class="token operator">&gt;</span> <span class="token punctuation">(</span>OS_TICK<span class="token punctuation">)</span><span class="token number">0u</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果延时节拍数&gt;0</span>
		<span class="token function">OS_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//进入临界段</span>
		OSTCBCurPtr<span class="token operator">-&gt;</span>TaskState <span class="token operator">=</span> OS_TASK_STATE_DLY<span class="token punctuation">;</span> <span class="token comment">//修改当前任务的任务状态为延时状态</span>
		<span class="token function">OS_TickListInsert</span><span class="token punctuation">(</span>OSTCBCurPtr<span class="token punctuation">,</span> <span class="token comment">//将当前任务插入节拍列表</span>
                          ticks<span class="token punctuation">,</span>
                          opt_time<span class="token punctuation">,</span>
                          p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p_err <span class="token operator">!=</span> OS_ERR_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果当前任务插入节拍列表时出现错误</span>
			<span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退出临界段(无调度)</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//返回,不执行延时操作</span>
		<span class="token punctuation">}</span>
		<span class="token function">OS_RdyListRemove</span><span class="token punctuation">(</span>OSTCBCurPtr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从就绪列表移除当前任务</span>
		<span class="token function">OS_CRITICAL_EXIT_NO_SCHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退出临界段(无调度)</span>
		<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//任务切换</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;无错误&quot;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果延时节拍数 =0</span>
	<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_TIME_ZERO_DLY<span class="token punctuation">;</span> <span class="token comment">//错误类型为&quot;0 延时&quot;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br></div></div><p>任务延时的可选选项opt</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_OPT_TIME_DLY</span> <span class="token expression">DEF_BIT_NONE</span></span>
<span class="token number">2</span> #define <span class="token function">OS_OPT_TIME_TIMEOUT</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span>DEF_BIT_01<span class="token punctuation">)</span>
<span class="token number">3</span> #define <span class="token function">OS_OPT_TIME_MATCH</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span>DEF_BIT_02<span class="token punctuation">)</span>
<span class="token number">4</span> #define <span class="token function">OS_OPT_TIME_PERIODIC</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span>DEF_BIT_03<span class="token punctuation">)</span>
<span class="token number">56</span> #define <span class="token function">OS_OPT_TIME_HMSM_STRICT</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span>DEF_BIT_NONE<span class="token punctuation">)</span>
<span class="token number">7</span> #define <span class="token function">OS_OPT_TIME_HMSM_NON_STRICT</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_OPT<span class="token punctuation">)</span>DEF_BIT_04<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><p><code>OS_OPT_TIME_DLY</code>:dly为相对时间,就是从现在起延时多长时间,到时钟节拍总计数 <code>OSTickCtr = OSTickCtr</code>当前+dly时延时结束.</p></li> <li><p><code>OS_OPT_TIME_TIMEOUT</code>:跟<code>OS_OPT_TIME_DLY</code>的作用情况一样.</p></li> <li><p><code>OS_OPT_TIME_MATCH</code>:dly为绝对时间,就是从系统开始运行(调用<code>OSStart()</code>)时到节拍总计数<code>OSTickCtr = dly</code>时延时结束.</p></li> <li><p><code>OS_OPT_TIME_PERIODIC</code>:周期性延时, 跟<code>OS_OPT_TIME_DLY</code>的作用差不多,如果是长时间延时,该选项更精准一些.</p></li> <li><p>延时时间取值比较严格:</p> <p><strong>–</strong> 小时数hours:(0-99)</p> <p><strong>–</strong> 分钟数minutes:(0-59)</p> <p><strong>–</strong> 秒数seconds:(0-59)</p> <p><strong>–</strong> 毫秒数milliseconds:(0-999)</p></li> <li><p>延时时间取值比较宽松.</p> <p><strong>–</strong> 小时数hours:(0-999)</p> <p><strong>–</strong> 分钟数minutes:(0-9999)</p> <p><strong>–</strong> 秒数seconds:(0-65535)</p> <p><strong>–</strong> 毫秒数milliseconds:(0-4294967295)</p></li></ul></li></ul> <h2 id="任务的设计要点"><a href="#任务的设计要点" class="header-anchor">#</a> 任务的设计要点</h2> <ul><li><p>我们要对自己设计的嵌入式系统要了如指掌,任务的优先级信息,任务与中断的处理,任务的运行时间,逻辑,状态等都要知道,才能设计出好的系统,所以,在设计的时候需要根据需求制定框架.在设计之初就应该考虑任务运行的上下文环境,任务的执行时间的合理性.</p></li> <li><p>μC/OS中程序运行的上下文包括:</p> <ul><li>中断服务函数.</li> <li>普通任务.</li> <li>空闲任务.</li></ul> <ol><li><p>中断服务函数</p> <p>中断服务函数是一种需要特别注意的上下文环境,它运行在非任务的执行环境下(一般为芯片的一种特殊运行模式(也被称作特权模式)),在这个上下文环境中不能使用挂起当前任务的操作,不允许调用任何会阻塞运行的API函数接口.另外需要注意的是,中断服务程序最好保持精简短小,快进快出,一般在中断服务函数中只做标记事件的发生,然后通知任务,让对应任务去执行相关处理,因为中断服务函数的优先级高于任何优先级的任务,如果中断处理时间过长,将会导致整个系统的任务无法正常运行.所以在设计的时候必须考虑中断的频率,中断的处理时间等重要因素,以便配合对应中断处理任务的工作.</p> <p>μC/OS支持中断延迟发布,使得原本在中断中发布的信息变成任务级发布,这样子会使得中断服务函数的处理更加快速,屏蔽中断的时间更短,这样子能快速响应其他的中断,真正称得上实时操作系统.</p></li> <li><p>任务</p> <p>任务看似没有什么限制程序执行的因素,似乎所有的操作都可以执行.但是做为一个优先级明确的实时系统,如果一个任务中的程序出现了死循环操作(此处的死循环是指没有阻塞机制的任务循环体),那么比这个任务优先级低的任务都将无法执行,当然也包括了空闲任务,因为死循环的时候,任务不会主动让出CPU,低优先级的任务是不可能得到CPU的使用权的,而高优先级的任务就可以抢占CPU.这个情况在实时操作系统中是必须注意的一点,所以在任务中不允许出现死循环.如果一个任务只有就绪态而无阻塞态,势必会影响到其他低优先级任务的执行,所以在进行任务设计时,就应该保证任务在不活跃的时候,任务可以进入阻塞态以交出CPU使用权,这就需要我们自己明确知道什么情况下让任务进入阻塞态,保证低优先级任务可以正常运行.在实际设计中,一般会将紧急的处理事件的任务优先级设置得高一些.</p></li> <li><p>空闲任务</p> <p>空闲任务(idle 任务)是μC/OS系统中没有其他工作进行时自动进入的系统任务.因为处理器总是需要代码来执行,所以至少要有一个任务处于运行态.μC/OS为了保证这一点,当调用<code>OSInit()</code>函数进行系统初始化时,系统会自动创建一个空闲任务,空闲任务是一个非常短小的循环.用户可以通过空闲任务钩子方式,在空闲任务上钩入自己的功能函数.通常这个空闲任务钩子能够完成一些额外的特殊功能,例如系统运行状态的指示,系统省电模式等.空闲任务是唯一一个不允许出现阻塞情况的任务,因为μC/OS需要保证系统永远都有一个可运行的任务.</p> <p>对于空闲任务钩子上挂接的空闲钩子函数,它应该满足以下的条件:</p> <ul><li>永远不会挂起空闲任务.</li> <li>不应该陷入死循环,需要留出部分时间用于统计系统的运行状态等.</li></ul></li> <li><p>任务的执行时间</p> <p>任务的执行时间一般是指两个方面,一是任务从开始到结束的时间,二是任务的周期.在系统设计的时候这两个时间候我们都需要考虑,例如,对于事件A对应的服务任务Ta,系统要求的实时响应指标是10ms,而,Ta 的最大运行时间是1ms,那么10ms就是任务Ta的周期了,1ms则是任务的运行时间,简单来说任务Ta在10ms内完成对事件A的响应即可.此时,系统中还存在着以50ms为周期的另一任务Tb,它每次运行的最大时间长度是,100us.在这种情况下,即使把任务 Tb的优先级设置比Ta更高,对系统的实时性指标也没什么影响,因为即使在Ta的运行过程中,Tb抢占了Ta 的资源,等到Tb执行完毕,消耗的时间也只不过是100us,还是在事件A规定的响应时间内(10ms),Ta能够安全完成对事件A的响应.但是假如系统中还存在任务Tc,其运行时间为20ms,假如将Tc的优先级设置比Ta更高,那么在Ta运行的时候,突然间被Tc打断,等到Tc 执行完毕,那Ta已经错过对事件A(10ms)的响应了,这是不允许的.所以在我们设计的时候,必须考虑任务的时间,一般来说处理时间更短的任务优先级应设置更高一些.</p></li></ol></li></ul></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023/3/16 13:13:56</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-2a01419c data-v-2a01419c><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-2a01419c><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-2a01419c></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-2a01419c></path></svg></div><!----><div class="RibbonAnimation"></div></div></div>
    <script src="/assets/js/app.88e14013.js" defer></script><script src="/assets/js/3.a7922583.js" defer></script><script src="/assets/js/1.890579b8.js" defer></script><script src="/assets/js/24.7c4cca11.js" defer></script>
  </body>
</html>
